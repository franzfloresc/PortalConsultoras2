@model Portal.Consultoras.Web.Models.PedidoFICDetalleModel
@{
    ViewBag.Title = "Pedido FIC";
}
@section styles{
   
    <link href="@Url.Content("~/Content/Css/Site/style-pedido.css")" rel="stylesheet" />

    <style>
        .btn_animado {
            display: none;
            position: absolute;
            /*width: 70px;
            height: 30px;
            background: red;*/
            z-index: 1000;
            text-align: center;
        }

        .no_mostrar {
            display: none;
        }

        /*.campana:hover .info_cam {
            display:none;
        }*/
    </style>
}

<div class="franja_negra"></div>

<h1 class="titulo_principal_interiores pedido_left" style="margin-top:0px">INGRESA <strong>TU PEDIDO</strong></h1>
<div class="wrapper_general2">
    

    <input id="hdSimbolo" type="hidden" value="@Model.Simbolo" />

    <h1 class="titulo_principal_interiores pedido_left">INGRESA <strong>TU PEDIDO</strong></h1>
    <div class="clear"></div>

    <div class="pedido_ingreso_c2">
        <form id="frmInsertPedido" action="@Url.Action("Insert","Pedido")" method="post" role="form">
            

            <div id="divObservaciones" class="pedidos_no_existe" style="position:relative;">
            </div>

            <div class="pedido_ingreso_datos campo_codigo">
                <br />
                <input type="text" name="CUV" id="txtCUV" onblur="ValidarCUV();" maxlength="5" class="ValidaNumeral" placeholder="Código" />
            </div>

            <div class="pedido_ingreso_datos campo_descripcion_producto">
                @*Descripción Producto*@
                <br />
                <input type="text" name="DescripcionProd" id="txtDescripcionProd" maxlength="250" onblur="ValidarDescripcion();" class="ValidaAlfanumerico"
                       onkeyup="PreValidarCUV();" placeholder="Descripción producto" />
            </div>

            <div class="pedido_ingreso_datos campo_precio">
                @*Precio*@
                <br />
                <input id="txtPrecioR" disabled="disabled" class="preciounitario" placeholder="Precio" />
            </div>

            <div class="pedido_ingreso_datos campo_cantidad">
                @*Cantidad*@
                <br />
                <div class="liquidacion_rango_wrapper_pedido">
                    <input type="text" name="Cantidad" id="txtCantidad" value="1" maxlength="2" class="liquidacion_rango_cantidad_pedido ValidaNumeral"
                           onkeypress="PreValidarCUV();" onfocus="SeleccionarContenido(this)" />
                    <div class="liquidacion_rango_right_pedido">
                        <a class="mas"><img src="@Url.Content("~/Content/Images/Esika/mas.png")" alt="" /></a>
                        <a class="menos"><img src="@Url.Content("~/Content/Images/Esika/menos.png")" alt="" /></a>
                    </div>
                </div>
            </div>

            <div class="pedido_ingreso_datos campo_cliente">
                @*Cliente*@
                <br />
                <input type="text" name="ClienteDescripcion" id="txtClienteDescripcion" onblur="ValidarCliente();" onkeydown="ValidarClienteFocus();"
                       maxlength="50" class="ValidaAlfanumerico" placeholder="Cliente (Opcional)" />
                <span class="pedido_ingreso_datos_icono_mas">+</span>
                <a class="pedidos_cliente" onclick="AbrirModalCliente();">
                    AGREGAR NUEVO CLIENTE
                </a>
            </div>
            <input type="hidden" id="hdFlagNueva" />
            <input id="btnAgregar" type="submit" value="AGREGAR" disabled="disabled" onkeydown="Tabular()" class="pedido_agregado" />
        </form>
    </div>
    <div class="clear"></div>
    </div>





    <script type="text/javascript">

        function AbrirModalCliente() {
            //_gaq.push(['_trackEvent', 'Pedido', 'Nuevo-cliente']);
            $('#Nombres').val($('#txtClienteDescripcion').val());
            showDialog('divClientes');
        }

        function removerOptions(obj, index) {
            if (typeof index != "undefined")
                obj.remove(index);
        }

        function addCommas(nStr) {
            nStr += '';
            x = nStr.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? '.' + x[1] : '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + ',' + '$2');
            }
            return x1 + x2;
        }

        function QuitarEspacios(strChar) {
            return strChar.replace(/[ \t\r]+/g, "").toUpperCase();
        }

        function ClientByDelete() {
            CargarClientes();
            var ddlcliente = document.getElementById("ddlClientes");
            var cliSelected = document.getElementById("hdnClienteddl").value;
            if (cliSelected === "-1")
                ddlcliente.selectedIndex = 0;
            else
                for (var i = 0; i < ddlcliente.options.length; i++) {
                    if (QuitarEspacios(ddlcliente.options[i].text) === cliSelected) {
                        ddlcliente.selectedIndex = i;
                        break;
                    }
                }
            CambiarCliente(ddlcliente);
        }

        function addOptions(obj, item, value) {
            index = 0;
            total = obj.options.length;
            itemPart = QuitarEspacios(item);
            for (i = 1; i < obj.options.length; i++) {
                if (itemPart == "" || QuitarEspacios(obj.options[i].text) == itemPart)
                    break;
                else
                    index++;
            }
            if (index == total - 1)
                obj.options[total] = new Option(item, value);
        }

        function CambiarCliente(elem, id, nombre) {
            var index = 0;
            var monto = 0, simbolo = "";
            var nomCli = elem.options[elem.selectedIndex].text;
            var clientNomSel = QuitarEspacios(nomCli);
            var clientIDSel = elem.options[elem.selectedIndex].value;
            var DivMTotal = document.getElementById("divMtotCliente");
            $('#hdnClienteddl').val(clientNomSel);
            var gpedidos = document.getElementById("tbListadoPedido");
            var TRs = gpedidos.tBodies[0].getElementsByTagName("tr");
            for (var i = 0; i < TRs.length; i++) {
                TDs = TRs[i].getElementsByTagName('td');
                try {
                    var clientNom = QuitarEspacios(TDs[5].getElementsByTagName('input')[4].value);
                    if (clientNomSel == clientNom || clientIDSel == -1) {
                        TRs[i].style.display = "";
                        index++;
                        if (TDs[4].getElementsByTagName('label')[1])
                            monto += parseFloat(TDs[4].getElementsByTagName('label')[1].innerText.replace(/,/g, ""));
                        else
                            monto += parseFloat(TDs[4].getElementsByTagName('label')[0].innerText.replace(/,/g, ""));
                        simbolo = TDs[4].getElementsByTagName('span')[0].innerText;
                    }
                    else
                        TRs[i].style.display = "none";
                }
                catch (err) {
                }
            }
            DivMTotal.style.display = "none";
            if (index == 0) {
                for (var i = 0; i < TRs.length; i++) {
                    TRs[i].style.display = "";
                }
                if (clientIDSel != -1)
                    removerOptions(elem, elem.selectedIndex);
                elem.selectedIndex = 0;
            }
            else {
                if (clientIDSel != -1) {
                    DivMTotal.innerHTML = "Total " + nomCli + "&nbsp;&nbsp;&nbsp;&nbsp;" + simbolo + " " + addCommas(monto.toFixed(2));
                    DivMTotal.style.display = "block";
                }
            }
            if (typeof id != "undefined" && typeof nombre != "undefined")
                addOptions(elem, nombre, id);
        }

        function CargarClientes() {
            var gpedidos = document.getElementById("tbListadoPedido");
            var TRs = gpedidos.tBodies[0].getElementsByTagName("tr");

            var ddlCliente = document.getElementById("ddlClientes");
            var itemsFiltros = {};
            document.getElementById("divMtotCliente").style.display = "none";
            while (ddlCliente.firstChild) {
                ddlCliente.removeChild(ddlCliente.firstChild);
            }
            ddlCliente.options[ddlCliente.options.length] = new Option("-- TODOS --", -1);
            for (var i = 0; i < TRs.length; i++) {
                TDs = TRs[i].getElementsByTagName('td');
                try {
                    var clientID = TDs[5].getElementsByTagName('input')[2].value;
                    var clientName = TDs[5].getElementsByTagName('input')[4].value;
                    nuevocli = QuitarEspacios(clientName);
                    if (typeof itemsFiltros[nuevocli] == "undefined") {
                        itemsFiltros[nuevocli] = clientID;
                        itemsFiltros["length"] = i + 1;
                        ddlCliente.options[ddlCliente.options.length] = new Option(clientName, clientID);
                    }
                }
                catch (err) {
                }
            }
        }

        $(document).ready(function () {
            CargarClientes();
            IniDialog();
            $("#hdFlagValidacion").val("0");
            if ($('#hdfEstadoPedido').val() == "1") {
                $('#hdFlagValidacionReserva').val("1");
            }
            $('#DialogPackOfertasGratis').dialog({
                autoOpen: false,
                resizable: false,
                modal: true,
                closeOnEscape: true,
                width: 750,
                height: 500,
                draggable: true,
                title: "",
                close: function (event, ui) { ActualizarOfertaGratis(); }
            });
            $('#btnValidarPROL').click(function () {
                if (document.getElementById("tbListadoPedido").rows.length > 1 && $('#hdnIndicadorOfertaFIC').val() == 1) {
                    showDialog('divOfertaFIC');
                }
                else {
                    alert_msgstock("Su pedido ha sido guardado correctamente.");
                }

                //alert_msgstock("Su pedido ha sido guardado correctamente.");
                //$("#btnOfertasFIC").click();
            });
            $('#btnAgregarOferfaFIC').click(function () {

                GuardarOfertaFICenPedido();
                $('#divOfertaFIC').dialog('close');
            });
            $('#btnCancelarOferfaFIC').click(function () {
                $('#divOfertaFIC').dialog('close');
            });

            $('#txtCUV').autocomplete({
                source: baseUrl + "PedidoFIC/AutocompleteByProductoCUV",
                minLength: 4,
                select: function (event, ui) {
                    if (ui.item.MarcaID != 0) {
                        $("#hdTipoOfertaSisID").val(ui.item.TipoOfertaSisID);
                        $("#hdConfiguracionOfertaID").val(ui.item.ConfiguracionOfertaID);
                        ObservacionesProducto(ui.item);
                    }
                    return false;
                }
            }).data("autocomplete")._renderItem = function (ul, item) {
                return $("<li></li>")
                    .data("item.autocomplete", item)
                    .append("<a>" + item.CUV + "</a>")
                    .appendTo(ul);
            };

            $('#txtDescripcionProd').autocomplete({
                source: baseUrl + "PedidoFIC/AutocompleteByProductoDescripcion",
                minLength: 4,
                select: function (event, ui) {
                    if (ui.item.CUV != "0") {
                        $("#hdTipoOfertaSisID").val(ui.item.TipoOfertaSisID);
                        $("#hdConfiguracionOfertaID").val(ui.item.ConfiguracionOfertaID);
                        //if (ui.item.CUV != "0") {
                        ObservacionesProducto(ui.item);
                    }
                    return false;
                }
            }).data("autocomplete")._renderItem = function (ul, item) {
                return $("<li></li>")
                    .data("item.autocomplete", item)
                    .append("<a>" + item.Descripcion + "</a>")
                    .appendTo(ul);
            };

            $('#txtClienteDescripcion').autocomplete({
                source: baseUrl + "Pedido/AutocompleteByCliente",
                minLength: 4,
                select: function (event, ui) {
                    if (ui.item.ClienteID != 0) {
                        if (ui.item.ClienteID != -1) {
                            $("#hdfClienteID").val(ui.item.ClienteID);
                            $("#txtClienteDescripcion").val(ui.item.Nombre);
                            $("#hdfClienteDescripcion").val(ui.item.Nombre);
                        }
                        else {
                            $('#Nombres').val($("#txtClienteDescripcion").val());
                            showDialog("divClientes");
                        }
                    }
                    return false;
                }
            }).data("autocomplete")._renderItem = function (ul, item) {
                return $("<li></li>")
                    .data("item.autocomplete", item)
                    .append("<a>" + item.Nombre + "</a>")
                    .appendTo(ul);
            };


            $('.ValidaNumeral').keyup(function (evt) {
                var theEvent = evt || window.event;
                var key = theEvent.keyCode || theEvent.which;
                key = String.fromCharCode(key);
                var regex = /[0-9]|\./;
                if (!regex.test(key)) {
                    theEvent.returnValue = false;
                    if (theEvent.preventDefault) theEvent.preventDefault();
                }
            });

            $('.ValidaNumeral').keypress(function (e) {
                if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
                    return false;
                }
            });

            $('#txtCantidadRecomendado').keyup(function (evt) {
                var theEvent = evt || window.event;
                var key = theEvent.keyCode || theEvent.which;
                key = String.fromCharCode(key);
                var regex = /[0-9]|\./;
                if (!regex.test(key)) {
                    theEvent.returnValue = false;
                    if (theEvent.preventDefault) theEvent.preventDefault();
                }
            });

            $('#txtCantidadRecomendado').keypress(function (e) {
                if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
                    return false;
                }
            });


            $('.ValidaNumeralPedido').live('keyup', function (evt) {
                var theEvent = evt || window.event;
                var key = theEvent.keyCode || theEvent.which;
                key = String.fromCharCode(key);
                var regex = /[0-9]|\./;
                if (!regex.test(key)) {
                    theEvent.returnValue = false;
                    if (theEvent.preventDefault) theEvent.preventDefault();
                }
            });

            $('.ValidaNumeralPedido').live('keypress', function (e) {
                if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
                    return false;
                }
            });

            $("#txtCUV").keyup(function (evt) {
                if ($(this).val().length == 5) {
                    BuscarByCUV($(this).val());
                }
                else {
                    $("#txtCantidad").val("");
                    $("#hdfCUV").val("");
                    $("#hdfDescripcionProd").val("");
                    $("#txtDescripcionProd").val("");
                    $("#btnAgregar").attr("disabled", "disabled");
                    $("#divMensaje").text("");
                    $("#txtPrecioR").val("");
                }
            });

            $('.ValidaNumeralOferta').live('keyup', function (evt) {
                var theEvent = evt || window.event;
                var key = theEvent.keyCode || theEvent.which;
                key = String.fromCharCode(key);
                var regex = /[0-9]|\./;
                if (!regex.test(key)) {
                    theEvent.returnValue = false;
                    if (theEvent.preventDefault) theEvent.preventDefault();
                }
            });

            $('.ValidaNumeralOferta').live('keypress', function (e) {
                if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
                    return false;
                }
            });

            $(".ValidaAlfanumerico").keypress(function (evt) {
                var charCode = (evt.which) ? evt.which : window.event.keyCode;
                if (charCode <= 13) {
                    return true;
                }
                else {
                    var keyChar = String.fromCharCode(charCode);
                    var re = /[a-zA-Z0-9ñÑáéíóúÁÉÍÓÚ' ]/;
                    return re.test(keyChar);
                }
            });

            $(".ValidaAlfabeto").keypress(function (evt) {
                var charCode = (evt.which) ? evt.which : window.event.keyCode;
                if (charCode <= 13) {
                    return true;
                }
                else {
                    var keyChar = String.fromCharCode(charCode);
                    var re = /[a-zA-ZñÑáéíóúÁÉÍÓÚ' ]/;
                    return re.test(keyChar);
                }
            });

            $(".ValidarFormatoCorreo").keypress(function (evt) {
                var charCode = (evt.which) ? evt.which : window.event.keyCode;
                if (charCode <= 13) {
                    return true;
                }
                else {
                    var keyChar = String.fromCharCode(charCode);
                    var re = /[a-zA-Z0-9ñÑáéíóúÁÉÍÓÚ_.@@-]/;
                    return re.test(keyChar);
                }
            });

            // control que hace el verdadero submit (un button)
            $('form#frmInsertPedido').find('#btnAgregar').click(function () {
                //debugger;
                AgregarProductoListado();
            });
        });


        function GuardarOfertaFICenPedido() {
            $.ajax({
                type: "POST",
                url: baseUrl + "PedidoFIC/Insertar",
                //data: JSON.stringify(),
                contentType: 'application/json',
                success: function (data) {
                    if (checkTimeout(data)) {
                        closeWaitingDialog();

                        if (data.success == true) {
                            alert_msg(data.message);
                        }
                        else
                            alert_msg(data.message);
                    }
                },
                error: function (data, error) {
                    if (checkTimeout(data)) {
                        closeWaitingDialog();
                        alert_msg("Ocurrió un error inesperado al momento de registrar los datos. Consulte con su administrador del sistema para obtener mayor información");
                    }
                }
            });
        }


        function PreValidarCUV() {
            if (event.keyCode == 13) {
                if ($("#btnAgregar")[0].disabled == false) {
                    AgregarProductoListado();
                }
            }
        }

        function ValidarClienteFocus() {
            if (event.keyCode == 9) {
                if ($("#btnAgregar")[0].disabled == true) {
                    if (event.preventDefault)
                        event.preventDefault();
                    else
                        event.returnValue = false;
                    $("#txtCUV").focus();
                }
            }
        }

        function AgregarProductoListado() {
            if (!HorarioRestringido()) {
                var CUV = $('#txtCUV').val();
                if ($.trim(CUV) != "") {
                    $('form#frmInsertPedido').submit();
                }
            }
        }

        function HorarioRestringido(mostrarAlerta) {
            //debugger;
            mostrarAlerta = typeof mostrarAlerta !== 'undefined' ? mostrarAlerta : true;
            var horarioRestringido = false;
            $.ajaxSetup({
                cache: false
            });
            jQuery.ajax({
                type: 'GET',
                url: baseUrl + 'Pedido/EnHorarioRestringido',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                async: false,
                success: function (data) {
                    //debugger;
                    if (checkTimeout(data)) {
                        // esta en horario restringido
                        if (data.success == true) {
                            if (mostrarAlerta == true)
                                alert_msg(data.message);
                            horarioRestringido = true;
                        }
                        // no esta en horario restringido
                        //else {
                        //    horarioRestringido = false;

                        //}
                    }
                },
                error: function (data, error) {
                    //debugger;
                    if (checkTimeout(data)) {
                        alert_msg(data.message);
                    }
                }
            });
            return horarioRestringido;
        }


        function ConfirmarEliminarPedidoTotal() {
            var total = parseFloat($('#sTotal').html());
            if (total != 0) {
                AbrirSplash();
                EliminarPedido();
            }
        }

        function EliminarPedido() {
            if (HorarioRestringido()) {
                CerrarSplash();
                return;
            }
            var item = {};
            jQuery.ajax({
                type: 'POST',
                url: baseUrl + 'PedidoFIC/DeleteAll',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(item),
                async: true,
                success: function (data) {
                    if (checkTimeout(data)) {
                        location.href = '@Url.Action("Index")';
                    }
                },
                error: function (data, error) {
                    if (checkTimeout(data)) {
                        alert_msg(data.message);
                        CerrarSplash();
                    }
                }
            });
        }
        var isShown = false;
        function CargarAutocomplete() {
            //debugger;
            var array = $(".classClienteNombre");

            for (var i = 0; i < array.length; i++) {
                $('#' + array[i].id).focus(function () {
                    //alert('No se puede');
                    if (HorarioRestringido())
                        this.blur();
                });
                $('#' + array[i].id).autocomplete({
                    source: baseUrl + "Pedido/AutocompleteByClienteListado",
                    minLength: 4,
                    select: function (event, ui) {
                        //debugger;
                        if (ui.item.ClienteID != 0) {
                            $(this).val(ui.item.Nombre);
                            var hdf = this.id.replace('txtLPCli', 'hdfLPCli');
                            var hdfDes = this.id.replace('txtLPCli', 'hdfLPCliDes');
                            $('#' + hdf).val(ui.item.ClienteID);
                            $('#' + hdfDes).val(ui.item.Nombre);
                        }
                        isShown = false;
                        return false;
                    }
                }).data("autocomplete")._renderItem = function (ul, item) {
                    //debugger;
                    ul.mouseover(function () {
                        isShown = true;
                    }).mouseout(function () {
                        isShown = false;
                    });
                    return $("<li></li>")
                        .data("item.autocomplete", item)
                        .append("<a>" + item.Nombre + "</a>")
                        .appendTo(ul);
                };
            }
        }

        function EstadoActualizacion(PedidoDetalleID) {
            //if ($('#hdfLPEstado' + PedidoDetalleID).val() == "0") {
            //    $('#divContenedor' + PedidoDetalleID).css({ "display": "block" });
            //    $('#divContenedorE' + PedidoDetalleID).css({ "display": "none" });
            //    $('#hdfLPEstado' + PedidoDetalleID).val(1);
            //}
        }

        function CalcularImporteTotal(PedidoDetalleID) {
            var Cantidad = $('#txtLPCant' + PedidoDetalleID).val();
            var Unidad = $('#hdfLPPrecioU' + PedidoDetalleID).val();
            var Total = parseFloat(Cantidad * Unidad).toFixed(2)
            $('#lblLPImpTotal' + PedidoDetalleID).html(Total);
            //var Total = parseFloat($("#sTotal").text()) + parseFloat(Unidad);
            //$("#sTotal").text(parseFloat(Total).toFixed(2));
        }

        function CalcularTotalPedido() {
            var array = $(".classImporteTotal");
            var acumulador = 0;
            var acumulador_2 = 0;
            for (var i = 0; i < array.length; i++) {
                acumulador = acumulador + parseFloat($('#' + array[i].id).html().replace(',', ''));
            }

            $('#sTotal').html(acumulador.toFixed(2));
        }

        function Cancel(PedidoDetalleID) {
            $('#divContenedor' + PedidoDetalleID).css({ "display": "none" });
            $('#divContenedorE' + PedidoDetalleID).css({ "display": "block" });
            $('#hdfLPEstado' + PedidoDetalleID).val(0);
            $('#txtLPCant' + PedidoDetalleID).val($('#txtLPTempCant' + PedidoDetalleID).val());
            $('#hdfLPCli' + PedidoDetalleID).val($('#hdfLPTempCliId' + PedidoDetalleID).val());
            $('#txtLPCli' + PedidoDetalleID).val($('#hdfLPTempCliDes' + PedidoDetalleID).val());
            $('#hdfLPCliDes' + PedidoDetalleID).val($('#hdfLPTempCliDes' + PedidoDetalleID).val());

            var Cantidad = $('#txtLPTempCant' + PedidoDetalleID).val();
            var Unidad = $('#hdfLPPrecioU' + PedidoDetalleID).val().replace(',', '');
            var Total = parseFloat(Cantidad * Unidad).toFixed(2)
            $('#lblLPImpTotal' + PedidoDetalleID).html(Total);
        }

        function ObservacionesProducto(item) {
            if (item.TieneStock == true) {
                $("#divObservaciones").html("");
                if (item.EsExpoOferta == true) {
                    _gaq.push(['_trackEvent', 'Pedido', 'Producto-expoferta']);
                    $("#divObservaciones").append("<div class='noti'><div class='noti_message'>Producto de ExpoOferta.</div></div>");
                }
                if (item.CUVRevista.length != 0) {
                    _gaq.push(['_trackEvent', 'Pedido', 'Producto-revista']);
                    $("#divObservaciones").append("<div id='divProdRevista' class='noti'><div class='noti_message'>Producto en Revista GANA con oferta especial.</div></div>");
                    //$("#divObservaciones").append("<div id='divProdRevista' class='noti'><div class='noti_message'>Producto en Revista GANA con <span><strong>Código " + item.CUVRevista + ".</strong></span></div><div class='input_add4'><input id='btnIgnorarEO' type='button' value='Ignorar' onclick='Ignorar(1)'/></div><div class='input_add3'><input id='btnReemplazar' type='button' value='Reemplazar' onclick='Reemplazar(\"" + item.CUVRevista + "\")'/></div></div>");
                }
                if (item.CUVComplemento.length != 0)
                    $("#divObservaciones").append("<div id='divProdComplementario' class='noti'><div class='noti_message'>Este producto se complementa bien con el producto con <span><strong>Código " + item.CUVComplemento + ".</strong></span></div><div class='input_add4'><input id='btnIgnorarPC' type='button' value='Ignorar' onclick='Ignorar(2)'/></div><div class='input_add3'><input id='btnAgregarComp' type='submit' value='Agregar' onclick='AgregarComp(\"" + item.CUVComplemento + "\"," + item.MarcaID + "," + item.PrecioCatalogo + ")'/></div></div>");
                $("#btnAgregar").removeAttr("disabled");
            }
            else {
                _gaq.push(['_trackEvent', 'Pedido', 'Producto-agotado']);
                $("#divObservaciones").html("<div class='noti'><div class='noti_message'>Producto Agotado.</div></div>");
                $("#btnAgregar").attr("disabled", "disabled");
            }

            $("#txtCUV").val(item.CUV);
            $("#hdfCUV").val(item.CUV);
            $("#hdfMarcaID").val(item.MarcaID);
            $("#txtCantidad").val("1");
            $("#hdfPrecioUnidad").val(item.PrecioCatalogo);
            $("#txtPrecioR").val(parseFloat(item.PrecioCatalogo).toFixed(2));
            $("#txtDescripcionProd").val(item.Descripcion);
            $("#hdfDescripcionProd").val(item.Descripcion);
            $("#divMensaje").text("");
            $("#txtCantidad").focus();
        }

        function BuscarByCUV(CUV) {
            if (CUV != $('#hdfCUV').val()) {
                var item = {
                    CUV: CUV
                };
                waitingDialog({});
                jQuery.ajax({
                    type: 'POST',
                    url: baseUrl + 'PedidoFIC/FindByCUV',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(item),
                    async: true,
                    cache: false,
                    success: function (data) {
                        if (checkTimeout(data)) {
                            closeWaitingDialog();
                            if (data[0].MarcaID != 0) {
                                $("#hdTipoOfertaSisID").val(data[0].TipoOfertaSisID);
                                $("#hdConfiguracionOfertaID").val(data[0].ConfiguracionOfertaID);
                                ObservacionesProducto(data[0]);
                            }
                            else {
                                $("#divObservaciones").html("<div class='noti'><div class='noti_message'>" + data[0].CUV + "</div></div>");
                            }
                        }
                    },
                    error: function (data, error) {
                        if (checkTimeout(data)) {
                            closeWaitingDialog();
                            alert_msg(data.message);
                        }
                    }
                });
            }
        }

        function Reemplazar(CUVRevista) {
            $("#txtCUV").val(CUVRevista);
            $("#hdfCUV").val(CUVRevista);
            $("#divProdRevista").remove();
        }

        function AgregarComp(CUVComplemento, MarcaID, PrecioCatalogo) {
            $("#hdfCUVComplemento").val(CUVComplemento);
            $("#hdfMarcaIDComplemento").val(MarcaID);
            $("#hdfPrecioUnidadComplemento").val(PrecioCatalogo);
            $("#hdfTipo").val(2);
        }

        function Ignorar(tipo) {
            if (tipo == 1)
                $("#divProdRevista").remove();
            else
                $("#divProdComplementario").remove();
        }

        function BlurF(CampaniaID, PedidoID, PedidoDetalleID, FlagValidacion) {
            //debugger;
            if (isShown)
                return true;
            else
                Update(CampaniaID, PedidoID, PedidoDetalleID, FlagValidacion);
        }

        function Update(CampaniaID, PedidoID, PedidoDetalleID, FlagValidacion) {
            var CliID = $('#hdfLPCli' + PedidoDetalleID).val();
            var CliDes = $('#txtLPCli' + PedidoDetalleID).val();
            var CliDesVal = $('#hdfLPCliDes' + PedidoDetalleID).val();
            var Cantidad = $('#txtLPCant' + PedidoDetalleID).val();
            var CantidadAnti = $('#txtLPTempCant' + PedidoDetalleID).val();
            var ClienteAnti = $('#hdfLPTempCliDes' + PedidoDetalleID).val();
            var DesProd = $('#lblLPDesProd' + PedidoDetalleID).html();

            if (FlagValidacion == "1") {
                if (CantidadAnti == Cantidad)
                    return false;
            } else {
                if (ClienteAnti == CliDes)
                    return false;
            }

            if (Cantidad.length == 0) {
                alert_msg('Por favor ingrese una cantidad válida.');
                return;
            }

            if (Cantidad == 0) {
                alert_msg('Por favor ingrese una cantidad mayor a cero.');
                return;
            }

            if (CliDes.length != 0 && CliDes != CliDesVal) {
                alert_msg('Por favor ingrese un cliente válido.');
                return;
            }

            var PrecioUnidad = $('#hdfLPPrecioU' + PedidoDetalleID).val();
            if (CliDes.length == 0) {
                CliID = 0
            }


            var Cantidad = $('#txtLPCant' + PedidoDetalleID).val();
            var Unidad = $('#hdfLPPrecioU' + PedidoDetalleID).val();
            var Total = parseFloat(Cantidad * Unidad).toFixed(2)
            $('#lblLPImpTotal' + PedidoDetalleID).html(Total);
            var item = {
                CampaniaID: CampaniaID,
                PedidoID: PedidoID,
                PedidoDetalleID: PedidoDetalleID,
                ClienteID: CliID,
                Cantidad: Cantidad,
                PrecioUnidad: PrecioUnidad,
                ClienteDescripcion: CliDes,
                DescripcionProd: DesProd
            };

            AbrirSplash();
            jQuery.ajax({
                type: 'POST',
                url: baseUrl + 'PedidoFIC/Update',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(item),
                async: true,
                success: function (data) {
                    if (checkTimeout(data)) {
                        CerrarSplash();
                        if (data.success == true) {
                            var item = data.items;
                            if ($('#txtLPCli' + PedidoDetalleID).val().length == 0) {
                                $('#hdfLPCliDes' + PedidoDetalleID).val($('#hdfNomConsultora').val());
                                $('#txtLPCli' + PedidoDetalleID).val($('#hdfNomConsultora').val());
                            }
                            $('#txtLPTempCant' + PedidoDetalleID).val($('#txtLPCant' + PedidoDetalleID).val());
                            $('#hdfLPTempCliId' + PedidoDetalleID).val($('#hdfLPCli' + PedidoDetalleID).val());
                            $('#hdfLPTempCliDes' + PedidoDetalleID).val($('#txtLPCli' + PedidoDetalleID).val());
                            $('#divContenedor' + PedidoDetalleID).css({ "display": "none" });
                            $('#divContenedorE' + PedidoDetalleID).css({ "display": "block" });
                            $('#hdfLPEstado' + PedidoDetalleID).val(0);

                            CalcularTotalPedido();
                            //alert(data.message);
                            var ddlcliente = document.getElementById("ddlClientes");
                            CambiarCliente(ddlcliente, CliID, (CliDes == "" ? $('#hdfNomConsultora').val() : CliDes));
                        }
                    }
                },
                error: function (data, error) {
                    if (checkTimeout(data)) {
                        CerrarSplash();
                        alert_msg(data.message);
                    }
                }
            });

        }

        function ValidarCUV() {
            if ($("#hdfCUV").val() != "" && $("#txtCUV").val() != "") {
                if ($("#txtCUV").val() != $("#hdfCUV").val()) {
                    $("#divMensaje").text("Ud. debe seleccionar un producto válido.");
                    $("#btnAgregar").attr("disabled", "disabled");
                }
            } else {
                if ($("#txtCUV").val().length == 5) {
                    //BuscarByCUV($("#txtCUV").val());
                }
                else {
                    $("#txtCantidad").val("");
                    $("#hdfCUV").val("");
                    $("#hdfDescripcionProd").val("");
                    $("#txtDescripcionProd").val("");
                    $("#btnAgregar").attr("disabled", "disabled");
                    $("#divMensaje").text("");
                    $("#txtPrecioR").val("");
                }
            }
        }

        function ValidarDescripcion() {
            if ($("#hdfDescripcionProd").val() != "" && $("#txtDescripcionProd").val() != "") {
                if ($("#txtDescripcionProd").val() != $("#hdfDescripcionProd").val()) {
                    $("#divMensaje").text("Ud. debe seleccionar un producto válido.");
                    $("#btnAgregar").attr("disabled", "disabled");
                }
            } else {
                $("#txtCantidad").val("");
                $("#hdfCUV").val("");
                $("#txtCUV").val("");
                $("#hdfDescripcionProd").val("");
                $("#btnAgregar").attr("disabled", "disabled");
                $("#divMensaje").text("");
            }
        }

        function ValidarCliente() {
            if ($("#hdfClienteDescripcion").val() != "" && $("#txtClienteDescripcion").val() != "") {
                if ($("#txtClienteDescripcion").val() != $("#hdfClienteDescripcion").val()) {
                    $("#divMensaje").text("Ud. debe seleccionar un cliente válido.");
                }
            } else {
                $("#hdfClienteDescripcion").val("");
                $("#hdfClienteID").val("0");
                $("#divMensaje").text("");
            }

        }

        function PedidoOnSuccess() {

            if ($("#hdfTipo").val() != "2") {
                $("#hdfCUV").val("");
                $("#hdfDescripcionProd").val("");
                //$("#hdfClienteDescripcion").val("");
                $("#txtCUV").val("");
                $("#hdfMarcaID").val("");
                $("#hdfPrecioUnidad").val("");
                $("#txtPrecioR").val("");
                $("#txtDescripcionProd").val("");
                $("#txtCantidad").val("");
                //$("#hdfClienteID").val("");
                //$("#txtClienteDescripcion").val("");
                $("#txtClienteDescripcion").val($("#hdfClienteDescripcion").val());
                $("#btnAgregar").attr("disabled", "disabled");

                $("#hdfCUVComplemento").val("");
                $("#hdfMarcaIDComplemento").val("");
                $("#hdfPrecioUnidadComplemento").val("");
                $("#divObservaciones").html("");

            }
            else {
                $("#hdfCUVComplemento").val("");
                $("#hdfMarcaIDComplemento").val("");
                $("#hdfPrecioUnidadComplemento").val("");
                $("#divObservaciones").html("");
            }
            CalcularTotal();
            ClientByDelete();
            $("#txtCUV").focus();
        }

        function CalcularTotal() {
            $('#sSimbolo').html($('#hdfSimbolo').val());
            $('#sTotal').html($('#hdfTotal').val());
        }

        function SaveDeleteAnalytics() {
            _gaq.push(['_trackEvent', 'Pedido', 'Eliminar-Producto']);
        }

        function Cambiar(tipo) {
            $("#hdfTipo").val(tipo);
        }

        function IniDialog() {
            $('#divClientes').dialog({
                autoOpen: false,
                resizable: false,
                modal: true,
                closeOnEscape: true,
                width: 450,
                draggable: true,
                title: "Registro de Cliente",
                buttons:
                {
                    "Guardar": function () {
                        var vMessage = "";
                        if (jQuery.trim($('#Nombres').val()) == "")
                            vMessage += "- Debe ingresar el Nombre del Cliente.\n";

                        if (jQuery.trim($('#Correo').val()) != "") {
                            if (!validateEmail($('#Correo').val()))
                                vMessage += "- Debe ingresar un correo con la estructura válida.\n";
                        }

                        if (vMessage != "") {
                            alert_msg(vMessage);
                            $('#Nombres').focus();
                            return false;

                        }
                        else {
                            fnRegistrar();
                        }

                    },
                    "Cancelar": function () {
                        $(this).dialog('close');
                    }
                }
            });


            $('#divOfertaFIC').dialog({
                autoOpen: false,
                resizable: false,
                modal: true,
                closeOnEscape: false,
                width: 'auto',
                height: 'auto',
                draggable: true

            });


            $('#DialogMensajes').dialog({
                autoOpen: false,
                resizable: false,
                modal: true,
                closeOnEscape: true,
                width: 400,
                draggable: true,
                title: ":: Mensaje ::",
                buttons:
                {
                    "Aceptar": function () {
                        $(this).dialog('close');
                    }
                }
            });

            $('#DialogMensajesStock').dialog({
                autoOpen: false,
                resizable: false,
                modal: true,
                closeOnEscape: true,
                width: 470,
                draggable: true,
                title: ":: Mensaje ::",
                buttons:
                {
                    "Aceptar": function () {
                        $(this).dialog('close');
                    }
                }
            });
        }

        function alert_msg(message) {
            $('#DialogMensajes .message_text').html(message);
            $('#DialogMensajes').dialog('open');
        }

        function alert_msgstock(message) {
            $('#DialogMensajesStock .message_text').html(message);
            $('#DialogMensajesStock').dialog('open');
        }

        function fnRegistrar() {

            var item = {
                Nombre: $('#Nombres').val(),
                eMail: $('#Correo').val()
            };
            jQuery.ajax({
                type: 'POST',
                url: baseUrl + 'Pedido/RegistrarCliente',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(item),
                async: true,
                success: function (data) {
                    if (checkTimeout(data)) {
                        if (data.success == true) {
                            _gaq.push(['_trackEvent', 'Pedido', 'Nuevo-cliente', 'Guardar']);
                            $("#hdfClienteID").val(data.extra);
                            $("#txtClienteDescripcion").val($('#Nombres').val());
                            $("#hdfClienteDescripcion").val($('#Nombres').val());
                            $('#Nombres').val("");
                            $('#Correo').val("");
                            alert_msg(data.message);
                            HideDialog("divClientes");
                        }
                        else {
                            alert_msg(data.message);
                        }
                    }
                },
                error: function (data, error) {
                    if (checkTimeout(data)) {
                        alert_msg(data.message);
                        HideDialog("divClientes");
                    }
                }
            });
        }

        function AgregarOfertaWeb(CUV, MarcaID, PrecioUnidad, DesProd) {
            if ($("#hdfOWCantidad" + CUV).val() != 0) {
                $("#hdfCUVOW").val(CUV);
                $("#hdfMarcaIDOW").val(MarcaID);
                $("#hdfCantidadOW").val($("#hdfOWCantidad" + CUV).val());
                $("#hdfPrecioUnidadOW").val(PrecioUnidad);
                $("#hdfDesProductoOW").val(DesProd);
                alert_msg('Se agregó el producto a la lista de Pedidos');
                $("#frmInsert").submit();
            }
            else {
                alert_msg("Debe Ingresar un valor diferente de Cero.");
            }
        }

        function AbrirSplash() {
            waitingDialog({});
        }

        function CerrarSplash() {
            closeWaitingDialog();
        }

        function UpdateLiquidacion(CampaniaID, PedidoID, PedidoDetalleID, TipoOfertaSisID, CUV, FlagValidacion, CantidadModi) {
            if (HorarioRestringido())
                return;
            Update(CampaniaID, PedidoID, PedidoDetalleID, FlagValidacion);
        }

        function PedidoFailure(param) {
            alert_msg("Ocurrió un error. Por favor, vuelva a realizar la acción.");
        }

        function RedirectOfertasLiquidacion() {
            //_gaq.push(['_trackEvent', 'Pedido', 'Banner', 'Oferta-Liquidacion']);
            _gaq.push(['_trackEvent', 'Pedido', 'Click', 'Banner-Oferta-Web-Liquidación']);

            location.href = '@Url.Action("OfertasLiquidacion", "OfertaLiquidacion")';
        }

        function ProductosFaltantes() {
            //_gaq.push(['_trackEvent', 'Pedido', 'Link', 'Agotados']);
            _gaq.push(['_trackEvent', 'Pedido', 'Click', 'Banner-Oferta-Agotados']);
            _gaq.push(['_trackPageview', '/Somosbelcorp/Productos-Agotados']);
            $('#frmFaltantes').submit();
        }

        function Tabular() {
            if (event.keyCode == 9) {
                if (event.preventDefault)
                    event.preventDefault();
                else
                    event.returnValue = false;
                $("#txtCUV").focus();
            }
        }

    </script>

    <script type="text/javascript">
        function ExportExcel() {
            var m = true;
            if ($("#list").getGridParam("reccount") == 0) {
                m = confirm('La grilla se encuentra vacía.\n¿ Está seguro(a) que desea continuar con la operación ?');
            }
            if (!m) {
                return;
            }

            _gaq.push(['_trackEvent', 'Pedido', 'Productos-Agotados', 'Excel']);

            waitingDialog({});

            setTimeout(function () {
                DownloadAttachExcel()
            }, 0);
        }

        function DownloadAttachExcel() {
            if (checkTimeout()) {
                var content = baseUrl + "Pedido/ExportarExcelProductoFaltante";

                var iframe_ = document.createElement("iframe");
                iframe_.style.display = "none";
                iframe_.setAttribute("src", content);

                if (navigator.userAgent.indexOf("MSIE") > -1 && !window.opera) { // Si es Internet Explorer
                    iframe_.onreadystatechange = function () {
                        switch (this.readyState) {
                            case "loading":
                                waitingDialog({});
                                break;
                            case "complete":
                            case "interactive":
                            case "uninitialized":
                                closeWaitingDialog();
                                break;
                            default:
                                closeWaitingDialog();
                                break;
                        }
                    };
                }
                else {
                    // Si es Firefox o Chrome
                    $(iframe_).ready(function () {
                        closeWaitingDialog();
                    });
                }
                document.body.appendChild(iframe_);
            }
        }
    </script>

    <script type="text/javascript">
        var CE_SNAPSHOT_NAME = "Pedido_Registro";
    </script>
    <script type="text/javascript">
        setTimeout(function () {
            var a = document.createElement("script");
            var b = document.getElementsByTagName("script")[0];
            a.src = document.location.protocol + "//dnn506yrbagrg.cloudfront.net/pages/scripts/0017/4400.js?" + Math.floor(new Date().getTime() / 3600000);
            a.async = true; a.type = "text/javascript"; b.parentNode.insertBefore(a, b)
        }, 1);
    </script>


    <div id="loadingScreen"></div>

    <div id="divOfertaFIC">
        <div class="Content_modal">

            @if (ViewBag.IndicadorOfertaFIC == 1)
            {
                Html.RenderPartial("OfertaFIC");
            }

        </div>
    </div>

    @*<div id="divClientes">
            <div class="Content_modal">
                <div class="div-3">
                    <div class="titC">Nombres:</div>
                    <div class="selectA borde_redondeado">
                        <input type="text" maxlength="50" id="Nombres" class="input_search_form ValidaAlfabeto" />
                    </div>
                </div>
                <div class="div-3">
                    <div class="titC">Email:</div>
                    <div class="selectA borde_redondeado">
                        <input type="text" maxlength="80" id="Correo" class="input_search_form ValidarFormatoCorreo" />
                    </div>
                </div>
            </div>
        </div>*@
    @*<div id="DialogMensajes" style="display: none;">
            <div class="Content_modal">
                <div class="message_text">
                    Mensaje por defecto.
                </div>
            </div>
        </div>*@
    @*<div id="DialogMensajesStock" style="display: none;">
            <div class="message_text">
                Mensaje por defecto.
            </div>
        </div>*@
    @Html.HiddenFor(model => model.PaisID, new { id = "hdnPaisIso" })
    <input id="hdnClienteddl" type="hidden" value="-1" />
    <input id="hdnIndicadorOfertaFIC" type="hidden" value="@ViewBag.IndicadorOfertaFIC" />
    <div id="DialogMensajeEliminar" style="display: none;">
        <div class="Content_modal">
            <div class="modal_cross_eliminar">
                <div class="lista_cross">
                    <div align="center">Al eliminar el producto labial Ezensi Cód. 00945 automáticamente se eliminará el producto complementario</div>
                    <div align="center"><span>Devos Cód. 23145</span></div>
                    <div align="center"><b>¿Deseas continuar?</b></div>
                </div>

                <div class="ofertas_cross_cerrar" align="center">
                    <input type="button" value="Si">
                    <input type="button" value="No">
                </div>
            </div>
        </div>
    </div>
    @*<div id="DialogMensajesStock">
            <div class="Content_modal">
                <div class="message_text">
                    Mensaje por defecto.
                </div>
            </div>
        </div>*@

