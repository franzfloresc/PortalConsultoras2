@model Portal.Consultoras.Web.Models.MatrizComercialModel
@{
    ViewBag.Title = "Administración Matriz Comercial";
}
<script src="@Url.Content("~/Scripts/fileuploader.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.form.js")" type="text/javascript"></script>
<script type="text/javascript">
    var paisNombre = "";
    var isoPAIS = "";
    var paisID = 11;
    jQuery(document).ready(function () {
        fnGrilla();
        IniDialogMatriz();
        IniDialogDescProducto();
        IniForm();
        $("#btnBuscar").click(function () {
            var msjex = "";
            if ($("#ddlPais").val() == "")
                msjex += " - Debe seleccionar un País .\n";
            //if ($("#txtCodigoSAP").val() == "")
            //    msjex += " - Debe ingresar el Código de SAP .\n";

            if (msjex == "") {
                paisNombre = $("#ddlPais option:selected").text();
                paisID = $("#ddlPais").val();
                fnGrilla();
            }
            else {
                alert(msjex);
                return false;
            }
        });
        $(".qq-upload-list").css("display", "none");
        $.ajaxSetup({ cache: false });
        $('#ddlPais').change(function () {
            var Id = $(this).val();
            if (Id != "") {
                paisID = Id;
                waitingDialog({});
                $.getJSON(baseUrl + 'MatrizComercial/ObtenerISOPais', { paisID: paisID }, function (data) {
                    closeWaitingDialog();
                    isoPAIS = data.ISO;
                });
            } else
                $("#list").jqGrid("clearGridData", true).trigger("reloadGrid");
        });
        $("#lnkAdmDescripcion").click(function () {
            showDialog("DialogCargarDescProducto");
            LimpiarCargaDescProd();
            return false;
        });
    });

    function IniDialogDescProducto() {
        $('#DialogCargarDescProducto').dialog({
            autoOpen: false,
            resizable: false,
            modal: true,
            closeOnEscape: true,
            width: 480,
            draggable: true,
            title: "Carga de Nombres Completos de Productos",
            buttons:
            {
                "Cargar": function () {
                    $('#frmCargarDescripcion').submit();
                },
                "Cancelar": function () {
                    $(this).dialog('close');
                }
            }
        });
    }

    function IniForm() {
        $('#frmCargarDescripcion').ajaxForm({
            beforeSubmit: function () {
                waitingDialog({});
                var fileValue = $('#flDescProd').val();
                var extensiones = ['csv'];
                var get_ext;
                var message = '';
                //validar la extension del archivo
                get_ext = fileValue.split('.');
                get_ext = get_ext.reverse();

                if ($.inArray(get_ext[0].toLowerCase(), extensiones) == -1 && fileValue.length > 0)
                    message = message + '- El tipo de archivo es inválido, asegúrese de seleccionar con extensión (csv).'

                if (message.length > 0) {
                    closeWaitingDialog();
                    alert(message);
                    return false;
                }
            },
            success: fnRespuestaCargaProductos
        });
    }

    function LimpiarCargaDescProd() {
        var divcontainer = $('#flDescProd').closest('div');
        divcontainer.html(divcontainer.html());
    }

    function fnRespuestaCargaProductos(responseText, statusText, xhr, $form) {
        closeWaitingDialog();
        if (checkTimeout(responseText)) {
            $("#list").setGridParam({ datatype: 'json', page: 1 }).trigger('reloadGrid');
            alert(responseText);
            $('#DialogCargarDescProducto').dialog('close');
        }
    }

    function fnGrilla() {
        jQuery("#list").jqGrid({
            url: baseUrl + "MatrizComercial/ConsultarMatrizComercial",
            hidegrid: false,
            datatype: 'json',
            postData: ({
                paisID: function () { return $("#ddlPais").val() },
                codigoSAP: function () { return ($.trim($("#txtCodigoSAP").val())) }
            }),
            mtype: 'GET',
            contentType: "application/json; charset=utf-8",
            colNames: ['', 'Código SAP', 'Descripción Original', 'Descripción', 'Foto 01', 'Foto 02', 'Foto 03', ''],
            colModel: [
                { name: 'IdMatrizComercial', index: 'IdMatrizComercial', width: 20, editable: true, resizable: false, hidden: true },
                { name: 'CodigoSAP', index: 'CodigoSAP', width: 60, editable: true, resizable: false },
                { name: 'DescripcionOriginal', index: 'DescripcionOriginal', width: 280, editable: true, resizable: false },
                { name: 'Descripcion', index: 'Descripcion', width: 0, editable: true, resizable: false, hidden: true },
                { name: 'FotoProducto01', index: 'FotoProducto01', width: 60, editable: true, resizable: false, sortable: false, align: 'center', formatter: ShowImage }, //1644
                { name: 'FotoProducto02', index: 'FotoProducto02', width: 60, editable: true, resizable: false, sortable: false, align: 'center', formatter: ShowImage }, //1644
                { name: 'FotoProducto03', index: 'FotoProducto03', width: 60, editable: true, resizable: false, sortable: false, align: 'center', formatter: ShowImage }, //1644
                //{ name: 'Imagen', index: 'Imagen', width: 60, editable: true, resizable: false, sortable: false, align: 'center', formatter: ShowImage },
                { name: 'Options', index: 'Options', width: 40, editable: true, sortable: false, align: 'center', resizable: false, formatter: ShowActions }
            ],
            jsonReader:
                {
                    root: "rows",
                    page: "page",
                    total: "total",
                    records: "records",
                    repeatitems: true,
                    cell: "cell",
                    id: "id",
                    ISOPais: 'ISOPais'
                },
            pager: jQuery('#pager'),
            loadtext: 'Cargando datos...',
            recordtext: "{0} - {1} de {2} Registros",
            emptyrecords: 'No hay resultados',
            rowNum: 10,
            scrollOffset: 0,
            rowList: [10, 20, 30, 40, 50],
            sortname: 'Nombre',
            sortorder: 'asc',
            viewrecords: true,
            multiselect: false,
            height: 'auto',
            width: 930,
            pgtext: 'Pág: {0} de {1}',
            altRows: true,
            altclass: 'jQGridAltRowClass',
            loadComplete: function (data) {
                isoPAIS = data.ISOPais;
            },
            gridComplete: function () { }
        });
        jQuery("#list").jqGrid('navGrid', "#pager", { edit: false, add: false, refresh: false, del: false, search: false });
        jQuery("#list").setGridParam({ datatype: 'json', page: 1 }).trigger('reloadGrid');

        function ShowActions(cellvalue, options, rowObject) {
            //var Edit = "&nbsp;<a href='javascript:;' onclick=\"return jQuery('#list').Editar('" + rowObject[0] + "','" + rowObject[2] + "','" + rowObject[8] + "','" + rowObject[12] + "','" + rowObject[13] + "','" + rowObject[14] + "','" + rowObject[11] + "','" + rowObject[15] + "');\" >" + "<img src='@Url.Content("~/Content/Images/Edit.png")' alt='Editar Oferta Web' title='Editar Oferta Web' border='0' /></a>";
            var Edit = "&nbsp;<a href='javascript:;' onclick=\"return jQuery('#list').Editar('" + options.rowId + "','" + rowObject[0] + "');\" >" + "<img src='@Url.Content("~/Content/Images/Edit.png")' alt='Editar Oferta Web' title='Editar Oferta Web' border='0' /></a>";
            //var Del = "&nbsp;<a href='javascript:;' onclick=\"return jQuery('#list').Eliminar('" + options.rowId + "','" + rowObject[2] + "','" + rowObject[8] + "','" + rowObject[12] + "','" + rowObject[13] + "','" + rowObject[14] + "','" + rowObject[11] + "','" + rowObject[15] + "');\" >" + "<img src='@Url.Content("~/Content/Images/NotAllowed.png")' alt='Deshabilitar Oferta Web' title='Deshabilitar Oferta Web' border='0' /></a>";
            return Edit;
        };

        function ShowImage(cellvalue, options, rowObject) {
            var image = "";
            if (cellvalue != "") {
                // image = '<img src="' + '@Url.Content("~/Content/Matriz/")' + isoPAIS + "/" + cellvalue + '" alt="" width="70px" height="60px" title="" border="0" />';
                image = '<img src="' + cellvalue + '" alt="" width="70px" height="60px" title="" border="0" />';
            } else {
                image = '<img src="@Url.Content("~/Content/Images/prod_grilla_vacio.png")" alt="" width="60px" height="60px" title="" border="0" />';
            }
            return image;
        };
    }

    $.jgrid.extend({
        Editar: function (ID, FlagTransaccion) {
            if (ID) {
                LimpiarDatos();

                if (FlagTransaccion == "0")
                    $("#hdFlagTransaccion").val("0");
                else
                    $("#hdFlagTransaccion").val("1");

                $("#txtPaisModal").val(paisNombre);
                $('#txtCodigoSAPModal').val(jQuery("#list").jqGrid('getCell', ID, 'CodigoSAP'));
                $('#txtDescripcionOriginalModal').val(jQuery("#list").jqGrid('getCell', ID, 'DescripcionOriginal'));
                $('#txtDescripcionModal').val(jQuery("#list").jqGrid('getCell', ID, 'Descripcion'));
                $('#imagenProducto01').val($($("#list").jqGrid('getCell', ID, 'FotoProducto01')).attr('src').replace(/^.*[\\\/]/, ''));
                $('#imagenProducto02').val($($("#list").jqGrid('getCell', ID, 'FotoProducto02')).attr('src').replace(/^.*[\\\/]/, ''));
                $('#imagenProducto03').val($($("#list").jqGrid('getCell', ID, 'FotoProducto03')).attr('src').replace(/^.*[\\\/]/, ''));
                $('#imagenProductoAnterior01').val($($("#list").jqGrid('getCell', ID, 'FotoProducto01')).attr('src').replace(/^.*[\\\/]/, ''));
                $('#imagenProductoAnterior02').val($($("#list").jqGrid('getCell', ID, 'FotoProducto02')).attr('src').replace(/^.*[\\\/]/, ''));
                $('#imagenProductoAnterior03').val($($("#list").jqGrid('getCell', ID, 'FotoProducto03')).attr('src').replace(/^.*[\\\/]/, ''));
                // 1664 - Formatear la ruta de la imagen.
                var img01 = $('#imagenProducto01').val();
                if (img01.lastIndexOf("?") >= 0) {
                    img01 = img01.substring(0, img01.lastIndexOf("?"));
                    $('#imagenProducto01').val(img01);
                    $('#imagenProductoAnterior01').val(img01);
                }

                var img02 = $('#imagenProducto02').val();
                if (img02.lastIndexOf("?") >= 0) {
                    img02 = img02.substring(0, img02.lastIndexOf("?"));
                    $('#imagenProducto02').val(img02);
                    $('#imagenProductoAnterior02').val(img02);
                }

                var img03 = $('#imagenProducto03').val();
                if (img03.lastIndexOf("?") >= 0) {
                    img03 = img03.substring(0, img03.lastIndexOf("?"));
                    $('#imagenProducto03').val(img03);
                    $('#imagenProductoAnterior03').val(img03);
                }

                if ($.trim($("#imagenProducto01").val()) != "prod_grilla_vacio.png")
                    // $('#img01').attr('src', '@Url.Content("~/Content/Matriz/")' + isoPAIS + "/" + $("#imagenProducto01").val());
                    $('#img01').attr('src', $($("#list").jqGrid('getCell', ID, 'FotoProducto01')).attr('src'));
                else
                    $('#img01').attr('src', '@Url.Content("~/Content/Images/prod_grilla_vacio.png")');

                if ($.trim($("#imagenProducto02").val()) != "prod_grilla_vacio.png")
                    // $('#img02').attr('src', '@Url.Content("~/Content/Matriz/")' + isoPAIS + "/" + $("#imagenProducto02").val());
                    $('#img02').attr('src', $($("#list").jqGrid('getCell', ID, 'FotoProducto02')).attr('src'));
                else
                    $('#img02').attr('src', '@Url.Content("~/Content/Images/prod_grilla_vacio.png")');

                if ($.trim($("#imagenProducto03").val()) != "prod_grilla_vacio.png")
                    // $('#img03').attr('src', '@Url.Content("~/Content/Matriz/")' + isoPAIS + "/" + $("#imagenProducto03").val());
                    $('#img03').attr('src', $($("#list").jqGrid('getCell', ID, 'FotoProducto03')).attr('src'));
                else
                    $('#img03').attr('src', '@Url.Content("~/Content/Images/prod_grilla_vacio.png")');
                
                showDialog("DialogMatrizComercial");
            } else {
                alert("Debe seleccionar un Producto, verifique");
            }
            return false;
        }
    });

    function LimpiarDatos() {
        $("#txtPaisModal").val("");
        $("#txtCodigoSAPModal").val("");
        $("#imagenProducto01").val("");
        $("#imagenProducto02").val("");
        $("#imagenProducto03").val("");
        $("#hdFlagTransaccion").val("0");
        $('#img01').attr('src', '@Url.Content("~/Content/Images/prod_grilla_vacio.png")');
            $('#img02').attr('src', '@Url.Content("~/Content/Images/prod_grilla_vacio.png")');
            $('#img03').attr('src', '@Url.Content("~/Content/Images/prod_grilla_vacio.png")');
        }

        function IniDialogMatriz() {
            $('#DialogMatrizComercial').dialog({
                autoOpen: false,
                resizable: false,
                modal: true,
                closeOnEscape: true,
                width: 900,
                draggable: true,
                title: "Actualización de Matriz",
                buttons:
                {
                    "Guardar": function () {
                        var vMessage = "";
                        if (jQuery.trim($('#txtDescripcionModal').val()) == "" && $.trim($('#imagenProducto01').val()) == "" && $.trim($('#imagenProducto02').val()) == "" && $.trim($('#imagenProducto03').val()) == "")
                            vMessage += "- Debe ingresar una nueva descripción al producto o adjuntar por lo menos una imagen.\n";
                        if (vMessage != "") {
                            alert(vMessage);
                            return false;
                        } else {
                            RegistrarMatrizComercial();
                        }
                    },
                    "Cancelar": function () {
                        $(this).dialog('close');
                    }
                }
            });
        }


        function RegistrarMatrizComercial() {
            var accion = "";

            if ($("#hdFlagTransaccion").val() == "1")
                accion = "UpdateMatrizComercial";
            else
                accion = "InsertMatrizComercial";

            var Item = {
                CodigoSAP: $.trim($('#txtCodigoSAPModal').val()),
                DescripcionOriginal: $.trim($('#txtDescripcionOriginalModal').val()),
                Descripcion: $.trim($("#txtDescripcionModal").val()),
                FotoProducto01: $.trim($("#imagenProducto01").val()),
                FotoProducto02: $.trim($("#imagenProducto02").val()),
                FotoProducto03: $.trim($('#imagenProducto03').val()),
                FotoProductoAnterior01: $.trim($("#imagenProductoAnterior01").val()),
                FotoProductoAnterior02: $.trim($("#imagenProductoAnterior02").val()),
                FotoProductoAnterior03: $.trim($('#imagenProductoAnterior03').val()),
                PaisID: paisID
            };
            waitingDialog({ title: "Procesando" });
            jQuery.ajax({
                type: 'POST',
                url: baseUrl + 'MatrizComercial/' + accion,
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(Item),
                async: true,
                success: function (data) {
                    if (checkTimeout(data)) {
                        closeWaitingDialog();
                        if (data.success == true) {
                            alert(data.message);
                            HideDialog("DialogMatrizComercial");
                            LimpiarDatos();
                            jQuery("#list").setGridParam({ datatype: 'json', page: 1 }).trigger('reloadGrid');
                        }
                        else {
                            alert(data.message);
                        }
                    }
                },
                error: function (data, error) {
                    if (checkTimeout(data)) {
                        closeWaitingDialog();
                        alert(data.message);
                        HideDialog("DialogMatrizComercial");
                    }
                }
            });
        }

</script>
<div class="wrap_cab">
    <div class="filtros">
        <div class="elements">
            <div class="div-2">
                <h1>Actualización <span>Matriz</span></h1>
            </div>
            <div class="div-3">
                <div class="titB">País:</div>
                <div class="selectA borde_redondeado">
                    @Html.DropDownListFor(model => model.PaisID, new SelectList(Model.lstPais, "PaisID", "Nombre"), "-- Seleccionar --", new { id = "ddlPais" })
                </div>
                <div class="titG">Código SAP:</div>
                <div class="selectA borde_redondeado">
                    <input type="text" id="txtCodigoSAP" />
                </div>
                <div class="input_search">
                    <a href="#" id="lnkAdmDescripcion">
                        <img title="Carga de Nombres Completos de Productos" src='@Url.Content("~/Content/Images/add_name_prd.png")' alt="" />
                    </a>
                </div>
            </div>
            <div class="div-3">
                <div class="titB"></div>
                <div class="input_search">
                    <input type="button" value="Buscar" id="btnBuscar" name="">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="wrap">
    <div class="container clearfix">
        <div class="border-wrapper">
            <table id="list"></table>
            <div id="pager"></div>
        </div>
    </div>
</div>

<div id="DialogMatrizComercial" style="display: none;">
    <input id="hdFlagTransaccion" type="hidden" value="0" />
    <div class="Content_modal">
        <div class="div-3">
            <div class="titF">País:</div>
            <div class="selectP2 borde_redondeado">
                <input type="text" id="txtPaisModal" readonly="readonly" />
            </div>
            <div class="titG" style="width: 180px;">Código SAP:</div>
            <div class="selectP2 borde_redondeado">
                <input type="text" id="txtCodigoSAPModal" readonly="readonly" />
            </div>
        </div>
        <div class="div-3">
            <div class="titF">Descripción Original:</div>
            <div class="selectP2 borde_redondeado" style="width: 570px;">
                <input type="text" id="txtDescripcionOriginalModal" readonly="readonly" />
            </div>
            <div class="titG" style="width: 180px; display: none">Descripción:</div>
            <div class="selectP2 borde_redondeado" style="display: none">
                <input type="text" id="txtDescripcionModal" />
            </div>
        </div>
        <div class="div-3">
            <div class="titF">Imagen:</div>
            <div class="selectP2 borde_redondeado aligncenter" style="height: 162px;">
                <img src='@Url.Content("~/Content/Images/prod_grilla_vacio.png")' id="img01">
            </div>
            <div class="selectP2 borde_redondeado aligncenter" style="height: 162px;">
                <img src='@Url.Content("~/Content/Images/prod_grilla_vacio.png")' id="img02">
            </div>
            <div class="selectP2 borde_redondeado aligncenter" style="height: 162px;">
                <img src='@Url.Content("~/Content/Images/prod_grilla_vacio.png")' id="img03">
            </div>
        </div>
        <div class="div-3">
            <div class="titF"></div>
            <div class="titG" style="width: 180px;">
                <div class="input_search">
                    <input type="hidden" id="imagenProducto01" />
                    <input type="hidden" id="imagenProductoAnterior01" />
                    <div id="fpUpload01">
                        <script type="text/javascript">
                            $.ajaxSetup({ cache: false });
                            var uploader = new qq.FileUploader({
                                allowedExtensions: ['jpg', 'png', 'jpeg'],
                                element: document.getElementById('fpUpload01'),
                                action: '@Url.Action("ImageMatrizUpload", "FileUpload")',
                                onComplete: function (id, fileName, responseJSON) {
                                    if (checkTimeout(responseJSON)) {
                                        $(".qq-upload-list").css("display", "none");
                                        if (responseJSON.success) {
                                            $("#imagenProducto01").val(responseJSON.name);
                                            // req. 1664
                                            $('#img01').attr('src', '@Url.Content("~/Content/Temporales/")' + responseJSON.name);
                                        }
                                        else {
                                            alert(responseJSON.message);
                                        }
                                    }
                                },
                                onSubmit: function (id, fileName) { $(".qq-upload-list").css("display", "none"); },
                                onProgress: function (id, fileName, loaded, total) { $(".qq-upload-list").css("display", "none"); },
                                onCancel: function (id, fileName) { $(".qq-upload-list").css("display", "none"); }
                            });
                        </script>
                    </div>
                </div>
            </div>
            <div class="titG" style="width: 180px;">
                <div class="input_search">
                    <input type="hidden" id="imagenProducto02" />
                    <input type="hidden" id="imagenProductoAnterior02" />
                    <div id="fpUpload02">
                        <script type="text/javascript">
                            $.ajaxSetup({ cache: false });
                            var uploader = new qq.FileUploader({
                                allowedExtensions: ['jpg', 'png', 'jpeg'],
                                element: document.getElementById('fpUpload02'),
                                action: '@Url.Action("ImageMatrizUpload", "FileUpload")',
                                onComplete: function (id, fileName, responseJSON) {
                                    if (checkTimeout(responseJSON)) {
                                        $(".qq-upload-list").css("display", "none");
                                        if (responseJSON.success) {
                                            $("#imagenProducto02").val(responseJSON.name);
                                            // req. 1664
                                            $('#img02').attr('src', '@Url.Content("~/Content/Temporales/")' + responseJSON.name);
                                        }
                                        else {
                                            alert(responseJSON.message);
                                        }
                                    }
                                },
                                onSubmit: function (id, fileName) { $(".qq-upload-list").css("display", "none"); },
                                onProgress: function (id, fileName, loaded, total) { $(".qq-upload-list").css("display", "none"); },
                                onCancel: function (id, fileName) { $(".qq-upload-list").css("display", "none"); }
                            });
                        </script>
                    </div>
                </div>
            </div>
            <div class="titG" style="width: 180px;">
                <div class="input_search">
                    <input type="hidden" id="imagenProducto03" />
                    <input type="hidden" id="imagenProductoAnterior03" />
                    <div id="fpUpload03">
                        <script type="text/javascript">
                            $.ajaxSetup({ cache: false });
                            var uploader = new qq.FileUploader({
                                allowedExtensions: ['jpg', 'png', 'jpeg'],
                                element: document.getElementById('fpUpload03'),
                                action: '@Url.Action("ImageMatrizUpload", "FileUpload")',
                                onComplete: function (id, fileName, responseJSON) {
                                    if (checkTimeout(responseJSON)) {
                                        $(".qq-upload-list").css("display", "none");
                                        if (responseJSON.success) {
                                            $("#imagenProducto03").val(responseJSON.name);
                                            // req. 1664
                                            $('#img03').attr('src', '@Url.Content("~/Content/Temporales/")' + responseJSON.name);
                                        }
                                        else {
                                            alert(responseJSON.message);
                                        }
                                    }
                                },
                                onSubmit: function (id, fileName) { $(".qq-upload-list").css("display", "none"); },
                                onProgress: function (id, fileName, loaded, total) { $(".qq-upload-list").css("display", "none"); },
                                onCancel: function (id, fileName) { $(".qq-upload-list").css("display", "none"); }
                            });
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="DialogCargarDescProducto" style="display: none;">
    @using (Html.BeginForm("UpdDescripcionProductoMasivo", "MatrizComercial", FormMethod.Post, new { id = "frmCargarDescripcion", enctype = "multipart/form-data" }))
    {
        <div class="Content_modal">
            <div class="div-3">
                <div class="titC">
                    Archivo :
                </div>
                <div class="selectA borde_redondeado">
                    <input type="file" id="flDescProd" name="flDescProd" />
                </div>                
            </div>
            <div class="div-3">
                <div class="titC">
                </div>
                <div class="titAuto" style="text-align:left;">
                    <div>Formato de archivo (*.csv):</div>
                    <div>- Código SAP</div>
                    <div>- Descripción</div>
                </div>
            </div>
        </div>
    }
</div>
<div id="loadingScreen"></div>