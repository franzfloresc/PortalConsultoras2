@model Portal.Consultoras.Web.Models.MatrizComercialModel
@{
    ViewBag.Title = "Administración Matriz Comercial";
    string imagenVacia = "prod_grilla_vacio.png";
    int nroImagenes = 10;
    string idControl;
}

<script src="@Url.Content("~/Scripts/fileuploader.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.form.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/handlebars.js")" type="text/javascript"></script>

<script type="text/javascript">
    var paisNombre = "";
    var isoPAIS = "";
    var paisID = 11;
    var nroImagenes = '@nroImagenes';
    var imagenVacia = '@imagenVacia';

    jQuery(document).ready(function () {
        fnGrilla();
        IniDialogMatriz();
        IniDialogDescProducto();
        IniForm();
        $("#btnBuscar").click(function () {
            var msjex = "";

            if ($("#txtCodigoSAP").val() === "")
                msjex += " - Debe ingresar un Código SAP .\n";
            if (isNaN($("#txtCodigoSAP").val()))
                msjex += " - Debe ingresar un Código SAP válido.\n";
            if ($("#ddlPais").val() == "")
                msjex += " - Debe seleccionar un País .\n";
            //if ($("#txtCodigoSAP").val() == "")
            //    msjex += " - Debe ingresar el Código de SAP .\n";

            if (msjex == "") {
                paisNombre = $("#ddlPais option:selected").text();
                paisID = $("#ddlPais").val();
                fnGrilla();
            }
            else {
                alert(msjex);
                return false;
            }
        });
        $(".qq-upload-list").css("display", "none");
        $.ajaxSetup({ cache: false });
        $('#ddlPais').change(function () {
            var Id = $(this).val();
            if (Id != "") {
                paisID = Id;
                waitingDialog({});
                $.getJSON(baseUrl + 'MatrizComercial/ObtenerISOPais', { paisID: paisID }, function (data) {
                    closeWaitingDialog();
                    isoPAIS = data.ISO;
                });
            } else
                $("#list").jqGrid("clearGridData", true).trigger("reloadGrid");
        });
        $("#lnkAdmDescripcion").click(function () {
            showDialog("DialogCargarDescProducto");
            LimpiarCargaDescProd();
            return false;
        });
    });

    function IniDialogDescProducto() {
        $('#DialogCargarDescProducto').dialog({
            autoOpen: false,
            resizable: false,
            modal: true,
            closeOnEscape: true,
            width: 480,
            draggable: true,
            title: "Carga de Nombres Completos de Productos",
            buttons:
            {
                "Cargar": function () {
                    $('#frmCargarDescripcion').submit();
                },
                "Cancelar": function () {
                    $(this).dialog('close');
                }
            }
        });
    }

    function IniForm() {
        $('#frmCargarDescripcion').ajaxForm({
            beforeSubmit: function () {
                waitingDialog({});
                var fileValue = $('#flDescProd').val();
                var extensiones = ['csv'];
                var get_ext;
                var message = '';
                //validar la extension del archivo
                get_ext = fileValue.split('.');
                get_ext = get_ext.reverse();

                if ($.inArray(get_ext[0].toLowerCase(), extensiones) == -1 && fileValue.length > 0)
                    message = message + '- El tipo de archivo es inválido, asegúrese de seleccionar con extensión (csv).'

                if (message.length > 0) {
                    closeWaitingDialog();
                    alert(message);
                    return false;
                }
            },
            success: fnRespuestaCargaProductos
        });
    }

    function LimpiarCargaDescProd() {
        var divcontainer = $('#flDescProd').closest('div');
        divcontainer.html(divcontainer.html());
    }

    function fnRespuestaCargaProductos(responseText, statusText, xhr, $form) {
        closeWaitingDialog();
        if (checkTimeout(responseText)) {
            $("#list").setGridParam({ datatype: 'json', page: 1 }).trigger('reloadGrid');
            alert(responseText);
            $('#DialogCargarDescProducto').dialog('close');
        }
    }

    function fnGrilla() {
        jQuery("#list").jqGrid({
            url: baseUrl + "MatrizComercial/ConsultarMatrizComercial",
            hidegrid: false,
            datatype: 'json',
            postData: ({
                paisID: function () { return $("#ddlPais").val() },
                codigoSAP: function () { return ($.trim($("#txtCodigoSAP").val())) }
            }),
            mtype: 'GET',
            contentType: "application/json; charset=utf-8",
            colNames: ['', 'Código SAP',  'CUV', 'Descripción Original', 'Descripción', ''],
            colModel: [
                { name: 'IdMatrizComercial', index: 'IdMatrizComercial', width: 20, editable: true, resizable: false, hidden: true },
                { name: 'CodigoSAP', index: 'CodigoSAP', width: 50, editable: true, resizable: false },
                { name: 'CUV', index: 'CUV', width: 51, editable: true, resizable: false, sortable: false},
                { name: 'DescripcionOriginal', index: 'DescripcionOriginal', width: 210, editable: true, resizable: false },
                { name: 'Descripcion', index: 'Descripcion', width: 0, editable: true, resizable: false, hidden: true }, //1644
                { name: 'Options', index: 'Options', width: 40, editable: true, sortable: false, align: 'center', resizable: false, formatter: ShowActions }
            ],
            jsonReader:
                {
                    root: "rows",
                    page: "page",
                    total: "total",
                    records: "records",
                    repeatitems: true,
                    cell: "cell",
                    id: "id",
                    ISOPais: 'ISOPais'
                },
            pager: jQuery('#pager'),
            loadtext: 'Cargando datos...',
            recordtext: "{0} - {1} de {2} Registros",
            emptyrecords: 'No hay resultados',
            rowNum: 10,
            scrollOffset: 0,
            rowList: [10, 20, 30, 40, 50],
            sortname: 'Nombre',
            sortorder: 'asc',
            viewrecords: true,
            multiselect: false,
            height: 'auto',
            width: 1170,
            pgtext: 'Pág: {0} de {1}',
            altRows: true,
            altclass: 'jQGridAltRowClass',
            loadComplete: function (data) {
                isoPAIS = data.ISOPais;
            },
            gridComplete: function () { }
        });
        jQuery("#list").jqGrid('navGrid', "#pager", { edit: false, add: false, refresh: false, del: false, search: false });
        jQuery("#list").setGridParam({ datatype: 'json', page: 1 }).trigger('reloadGrid');

        function ShowActions(cellvalue, options, rowObject) {
            var Edit = "&nbsp;<a href='javascript:;' onclick=\"return jQuery('#list').Editar('" + options.rowId + "','" + rowObject[0] + "','" + rowObject[2] + "');\" >" + "<img src='@Url.Content("~/Content/Images/Edit.png")' alt='Editar Oferta Web' title='Editar Oferta Web' border='0' /></a>";           
            //var Del = "&nbsp;<a href='javascript:;' onclick=\"return jQuery('#list').Eliminar('" + options.rowId + "','" + rowObject[2] + "','" + rowObject[8] + "','" + rowObject[12] + "','" + rowObject[13] + "','" + rowObject[14] + "','" + rowObject[11] + "','" + rowObject[15] + "');\" >" + "<img src='@Url.Content("~/Content/Images/NotAllowed.png")' alt='Deshabilitar Oferta Web' title='Deshabilitar Oferta Web' border='0' /></a>";
            return Edit;
        };

        function ShowImage(cellvalue, options, rowObject) {
            var image = "";
            if (cellvalue != "") {
                image = '<img src="' + cellvalue + '" alt="" width="70px" height="60px" title="" border="0" />';
            } else {
                image = '<img src="@Url.Content("~/Content/Images/" + imagenVacia)" alt="" width="60px" height="60px" title="" border="0" />';
            }
            return image;
        };
    }

    $.jgrid.extend({
        Editar: editar
    });

    function getCell(id, campo) {
        return jQuery("#list").jqGrid('getCell', id, campo);
    }

    function obtenerImagenesByCodigoSap(codigoSAP) {
        return $.post(baseUrl + 'MatrizComercial/GetImagesBySapCode', { paisID: paisID, sapCode: codigoSAP });
    }

    function editar(id, flagTransaccion, CUV) {

        LimpiarDatos();

        $("#hdFlagTransaccion").val(flagTransaccion == '0' ? '0' : '1');

        var editData = {
            pais: paisNombre,
            codigoSAP: getCell(id, 'CodigoSAP'),
            descripcionOriginal: getCell(id, 'DescripcionOriginal'),
            descripcion: getCell(id, 'Descripcion'),
            CUV: CUV,
            imagenes: []
        };

        obtenerImagenesByCodigoSap(editData.codigoSAP).done(obtenerImagenesSuccess(editData));

        @*var objImg, objImgProd, objImgProdAnterior;
        var cellImagenSrc, cellImagenSrcFormat, idImagen, valorImagen;
        for (var i = 1; i <= nroImagenes; i++) {
            idImagen = ('0' + i).substr(-2);
            objImg = $('#img' + idImagen); //img

            //hiddens
            objImgProd = $('#imagenProducto' + idImagen);
            objImgProdAnterior = $('#imagenProductoAnterior' + idImagen);

            cellImagenSrc = $($("#list").jqGrid('getCell', ID, 'FotoProducto' + idImagen)).attr('src'); //src de la imagen en grilla
            cellImagenSrcFormat = cellImagenSrc.replace(/^.*[\\\/]/, ''); //remplazar caracteres

            objImgProd.val(cellImagenSrcFormat); //actualiza hidden con el formato
            objImgProdAnterior.val(cellImagenSrcFormat);//actualiza hidden con el formato


            valorImagen = cellImagenSrcFormat; //si tiene ? la url de la imagen removerle y reasignar hiddens
            if (valorImagen.lastIndexOf("?") >= 0) {
                valorImagen = valorImagen.substring(0, valorImagen.lastIndexOf("?"));
                objImgProd.val(valorImagen);
                objImgProdAnterior.val(valorImagen);
            }

            //si la imagen src no es vacia actualizar la imagen con su nuevo src. 

            if ($.trim(valorImagen) != imagenVacia) objImg.attr('src', cellImagenSrc);
            else objImg.attr('src', '@Url.Content("~/Content/Images/" + imagenVacia)');
        }*@

        //showDialog("matriz-comercial-dialog");

        return false;
    }

    function obtenerImagenesSuccess(editData) {
        return function (data, textStatus, jqXHR) {
            editData.imagenes = data;
            SetHandlebars("#matriz-comercial-template", editData, '#matriz-comercial-dialog');
            showDialog("matriz-comercial-dialog");
        };
    }

    function LimpiarDatos() {
        $("#txtPaisModal").val("");
        $("#txtCodigoSAPModal").val("");
        $("#hdFlagTransaccion").val("0");
        $('.input-imagen-producto-anterior').val("");
        $('.img-matriz-comercial').attr('src', '@Url.Content("~/Content/Images/" + imagenVacia)');
    }

    function IniDialogMatriz() {
        $('#matriz-comercial-dialog').dialog({
            autoOpen: false,
            resizable: false,
            modal: true,
            closeOnEscape: true,
            width: 900,
            draggable: true,
            title: "Actualización de Matriz",
            buttons:
            {
                "Guardar": function () {
                    var vMessage = "", valImgProd, idImagen;

                    var ingresoAlgo = ($.trim($('#txtDescripcionModal').val()) != "");
                    for (var i = 1; i <= nroImagenes; i++) {
                        if (ingresoAlgo) break;

                        idImagen = ('0' + i).substr(-2);
                        valImgProd = $.trim($('#imagenProducto' + idImagen).val());
                        ingresoAlgo = (valImgProd != "" && valImgProd != imagenVacia);
                    }
                    if (!ingresoAlgo) vMessage += "- Debe ingresar una nueva descripción al producto o adjuntar por lo menos una imagen.\n";

                    if (vMessage != "") {
                        alert(vMessage);
                        return false;
                    }
                    else RegistrarMatrizComercial();
                },
                "Cancelar": function () { $(this).dialog('close'); }
            }
        });
    }

    function RegistrarMatrizComercial() {
        var objImgProd, objImgProdAnterior, idImagen;

        var item = {
            CodigoSAP: $.trim($('#txtCodigoSAPModal').val()),
            DescripcionOriginal: $.trim($('#txtDescripcionOriginalModal').val()),
            Descripcion: $.trim($("#txtDescripcionModal").val()),
            PaisID: paisID
        };
        for (var i = 1; i <= nroImagenes; i++) {
            idImagen = ('0' + i).substr(-2);
            objImgProd = $('#imagenProducto' + idImagen);
            objImgProdAnterior = $('#imagenProductoAnterior' + idImagen);
            item['FotoProducto' + idImagen] = objImgProd.val();
            item['FotoProductoAnterior' + idImagen] = objImgProdAnterior.val();
        }

        waitingDialog({ title: "Procesando" });
        var accion = ($("#hdFlagTransaccion").val() == "1") ? "UpdateMatrizComercial" : "InsertMatrizComercial";
        jQuery.ajax({
            type: 'POST',
            url: baseUrl + 'MatrizComercial/' + accion,
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(item),
            async: true,
            success: function (data) {
                if (checkTimeout(data)) {
                    closeWaitingDialog();
                    if (data.success == true) {
                        alert(data.message);
                        HideDialog("matriz-comercial-dialog");
                        LimpiarDatos();
                        jQuery("#list").setGridParam({ datatype: 'json', page: 1 }).trigger('reloadGrid');
                    }
                    else {
                        alert(data.message);
                    }
                }
            },
            error: function (data, error) {
                if (checkTimeout(data)) {
                    closeWaitingDialog();
                    alert(data.message);
                    HideDialog("matriz-comercial-dialog");
                }
            }
        });
    }
</script>
<div class="wrap_cab">
    <div class="filtros">
        <div class="elements">
            <div class="div-2">
                <h1>Actualización <span>Matriz</span></h1>
            </div>
            <div class="div-3">
                <div class="titB">País:</div>
                <div class="selectA borde_redondeado">
                    @Html.DropDownListFor(model => model.PaisID, new SelectList(Model.lstPais, "PaisID", "Nombre"), "-- Seleccionar --", new { id = "ddlPais" })
                </div>
                <div class="titG">Código SAP:</div>
                <div class="selectA borde_redondeado">
                    <input type="text" id="txtCodigoSAP"/>
                </div>
                <div class="input_search">
                    <a href="#" id="lnkAdmDescripcion">
                        <img title="Carga de Nombres Completos de Productos" src='@Url.Content("~/Content/Images/add_name_prd.png")' alt="" />
                    </a>
                </div>
            </div>
            <div class="div-3">
                <div class="titB"></div>
                <div class="input_search">
                    <input type="button" value="Buscar" id="btnBuscar" name="">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="wrap">
    <div class="container clearfix" style="width:1180px;">
        <div class="border-wrapper">
            <table id="list"></table>
            <div id="pager"></div>
        </div>
    </div>
</div>

@Html.Partial("MatrizComercialDialog")
<div id="matriz-comercial-dialog" style="display: none;"></div>

<div id="DialogCargarDescProducto" style="display: none;">
    @using (Html.BeginForm("UpdDescripcionProductoMasivo", "MatrizComercial", FormMethod.Post, new { id = "frmCargarDescripcion", enctype = "multipart/form-data" }))
    {
        <div class="Content_modal">
            <div class="div-3">
                <div class="titC">
                    Archivo :
                </div>
                <div class="selectA borde_redondeado">
                    <input type="file" id="flDescProd" name="flDescProd" />
                </div>                
            </div>
            <div class="div-3">
                <div class="titC">
                </div>
                <div class="titAuto" style="text-align:left;">
                    <div>Formato de archivo (*.csv):</div>
                    <div>- Código SAP</div>
                    <div>- Descripción</div>
                </div>
            </div>
        </div>
    }
</div>
<div id="loadingScreen"></div>