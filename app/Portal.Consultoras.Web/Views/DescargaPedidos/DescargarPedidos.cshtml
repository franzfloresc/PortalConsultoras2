@model Portal.Consultoras.Web.Models.DescargarPedidoModel
@{
    ViewBag.Title = "Cronograma";
}
<script type="text/javascript">
    jQuery(function () {
        IniFecha();
        fnGrilla();
        $("#btnDescargar").click(function () {
            RealizarDescarga();
        });

        $("#cboTipoCronograma").change(function () {
            $("#DivMensajeLideres").hide();
            $("#DivDescargas").hide();
        });

        $("#ddlPais").attr("disabled", true);
    });

    function IniFecha() {

        $("#txtFechaFacturacion").datepicker({
            showOn: "button",
            buttonImage: '@Url.Content("~/Content/Images/calendar.png")',
            buttonImageOnly: true,
            dateFormat: 'dd/mm/yy'
        }).mask('99/99/9999');
    }

    function RealizarDescarga() {
        var vMessage = "";
        $("#DivDescargas").hide();
        $("#Aheader").text("");
        $("#Ddetail").text("");

        if ($("#ddlPais").val() == "") {
            vMessage += "Debe seleccionar un País";
        }

        if (jQuery.trim($("#cboTipoCronograma").val()) == "0") {
            vMessage += "Debe selecionar el tipo de cronograma. \n";
        }

        if (jQuery.trim($("#txtFechaFacturacion").val()) == "") {
            vMessage += "Debe ingresar la Fecha de Facturación.\n";
        }

        if (vMessage != "") {
            alert(vMessage);
            return false;
        }
        else {
            var waiting = {
                message: 'Espere unos minutos, por favor...',
                title: 'Ejecutando Proceso'
            }
            waitingDialog(waiting);

            var JsonData = {
                PaisID: $("#ddlPais").val(),
                FechaFacturacion: $("#txtFechaFacturacion").val(),
                TipoCronogramaID: $("#cboTipoCronograma").val(),
                FlagPedidos: $("#chkMarcarPedidos").is("checked")
            };

            if (jQuery.trim($("#cboTipoCronograma").val()) != "4" && jQuery.trim($("#cboTipoCronograma").val()) != "5" && jQuery.trim($("#cboTipoCronograma").val()) != "6") {//R2382
                $.ajax({
                    type: 'POST',
                    url: baseUrl + 'DescargaPedidos/RealizarDescarga',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(JsonData),
                    async: true,
                    success: function (data) {
                        if (checkTimeout(data)) {
                            closeWaitingDialog();
                            if (data.success == true) {
                                alert(data.mensaje);
                                //setInterval(function () { Confirmacion(JsonData) }, 10000);
                                if (data.cabecera) {
                                    if (data.IsFox) {
                                        $("#Aheader").text("OCWPEDCA.TXT");//data.cabecera
                                        $("#Ddetail").text("OCWPEDDE.TXT");//data.detalle
                                        $("#Ddetail1").text("ACTDATOS.TXT");//data.detalle CGI (VVA) 2450
                                        $("#hdnfileHeader").val(data.rutac);
                                        $("#hdnfileDetail").val(data.rutad);
                                        $("#hdnfileDetailAct").val(data.rutae);//data.detalle CGI (VVA) 2450
                                        $("#DivDescargas").show();
                                    }
                                }
                            }
                            else {
                                alert(data.mensaje);
                            }
                        }
                    },
                    error: function (data, error) {
                        if (checkTimeout(data)) {
                            closeWaitingDialog();
                            alert("Error del Sistema.");
                        }
                    }
                });
            }
            else {
                // 2382 - Inicio
                if (jQuery.trim($("#cboTipoCronograma").val()) == "5") {
                    $.ajax({
                        type: 'POST',
                        url: baseUrl + 'DescargaPedidos/RealizarDescarga',
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(JsonData),
                        async: true,
                        success: function (data) {
                            if (checkTimeout(data)) {
                                closeWaitingDialog();
                                if (data.success == true) {
                                    alert(data.mensaje);

                                    if (data.cabecera) {

                                        if (data.IsFox && data.cantidad > 0) {
                                            $("#spCantidad").html(data.cantidad);
                                            $("#liderHeader").html(data.nombre);
                                            $("#hdnfileHeader").val(data.rutac);
                                            $("#DivMensajeLideres").show();
                                        }
                                    }
                                }
                                else {
                                    alert(data.mensaje);
                                }
                            }
                        },
                        error: function (data, error) {
                            if (checkTimeout(data)) {
                                closeWaitingDialog();
                                alert("Error del Sistema.");
                            }
                        }
                    });
                }
                    // 2382 - Fin
                else {
                    // R20151003 - Inicio
                    if (jQuery.trim($("#cboTipoCronograma").val()) == "6") {

                        $.ajax({
                            type: 'POST',
                            url: baseUrl + 'DescargaPedidos/RealizarDescargaDDParcial',
                            dataType: 'json',
                            contentType: 'application/json; charset=utf-8',
                            data: JSON.stringify(JsonData),
                            async: true,
                            success: function (data) {
                                if (checkTimeout(data)) {
                                    closeWaitingDialog();
                                    if (data.success == true) {
                                        alert(data.mensaje);
                                        if (data.cabecera) {
                                            if (data.IsFox) {
                                                $("#Aheader").text("OCWPEDCA.TXT");//data.cabecera
                                                $("#Ddetail").text("OCWPEDDE.TXT");//data.detalle                                              
                                                $("#hdnfileHeader").val(data.rutac);
                                                $("#hdnfileDetail").val(data.rutad);
                                                $("#DivDescargas").show();
                                            }
                                        }
                                    }
                                    else {
                                        alert(data.mensaje);
                                    }
                                }
                            },
                            error: function (data, error) {
                                if (checkTimeout(data)) {
                                    closeWaitingDialog();
                                    alert("Error del Sistema.");
                                }
                            }
                        });


                    } else {  // R20151003 - Fin

                        $.ajax({
                            type: 'POST',
                            url: baseUrl + 'DescargaPedidos/RealizarDescargaFIC',
                            dataType: 'json',
                            contentType: 'application/json; charset=utf-8',
                            data: JSON.stringify(JsonData),
                            async: true,
                            success: function (data) {
                                if (checkTimeout(data)) {
                                    closeWaitingDialog();
                                    if (data.success == true) {
                                        alert(data.mensaje);
                                        //setInterval(function () { Confirmacion(JsonData) }, 10000);
                                        if (data.cabecera) {
                                            if (data.IsFox) {
                                                if ($("#ddlPais").val() == 9) {
                                                    $("#Aheader").text("OCWPEDFICCA.TXT");//data.cabecera
                                                    $("#Ddetail").text("OCWPEDFICDE.TXT");//data.detalle

                                                } else {
                                                    $("#Aheader").text("OCWPEDCA.TXT");//data.cabecera
                                                    $("#Ddetail").text("OCWPEDDE.TXT");//data.detalle
                                                }
                                                $("#hdnfileHeader").val(data.rutac);
                                                $("#hdnfileDetail").val(data.rutad);

                                                $("#DivDescargas").show();
                                            }
                                        }
                                    }
                                    else {
                                        alert(data.mensaje);
                                    }
                                }
                            },
                            error: function (data, error) {
                                if (checkTimeout(data)) {
                                    closeWaitingDialog();
                                    alert("Error del Sistema.");
                                }
                            }
                        });
                    }
                }
            }
        }
    }

    function DescargarCabecera() {
        waitingDialog({});
        setTimeout(function () { DownloadAttachExcelHead() }, 0);
    }

    function DownloadAttachExcelHead() {
        var iframe_ = document.createElement("iframe");
        iframe_.style.display = "none";
        var requestedFile = encodeURIComponent($("#hdnfileHeader").val());
        iframe_.setAttribute("src", baseUrl + 'WebPages/Download.aspx?file=' + requestedFile);

        if (navigator.userAgent.indexOf("MSIE") > -1 && !window.opera) { // Si es Internet Explorer
            iframe_.onreadystatechange = function () {
                switch (this.readyState) {
                    case "loading":
                        waitingDialog({});
                        break;
                    case "complete":
                    case "interactive":
                    case "uninitialized":
                        closeWaitingDialog();
                        break;
                    default:
                        closeWaitingDialog();
                        break;
                }
            };
        }
        else {
            // Si es Firefox o Chrome
            $(iframe_).ready(function () {
                closeWaitingDialog();
            });
        }
        document.body.appendChild(iframe_);
    }

    function DescargarDetalle() {
        waitingDialog({});
        setTimeout(function () { DownloadAttachExcelDet() }, 0);
    }

    function DescargarDetalleAct() {
        waitingDialog({});
        setTimeout(function () { DownloadAttachExcelDetAct() }, 0);
    }

    function DownloadAttachExcelDetAct() {
        var iframe_ = document.createElement("iframe");
        iframe_.style.display = "none";
        var requestedFile = encodeURIComponent($("#hdnfileDetailAct").val());
        iframe_.setAttribute("src", baseUrl + 'WebPages/Download.aspx?file=' + requestedFile);

        if (navigator.userAgent.indexOf("MSIE") > -1 && !window.opera) { // Si es Internet Explorer
            iframe_.onreadystatechange = function () {
                switch (this.readyState) {
                    case "loading":
                        waitingDialog({});
                        break;
                    case "complete":
                    case "interactive":
                    case "uninitialized":
                        closeWaitingDialog();
                        break;
                    default:
                        closeWaitingDialog();
                        break;
                }
            };
        }
        else {
            // Si es Firefox o Chrome
            $(iframe_).ready(function () {
                closeWaitingDialog();
            });
        }
        document.body.appendChild(iframe_);
    }

    function DownloadAttachExcelDet() {
        var iframe_ = document.createElement("iframe");
        iframe_.style.display = "none";
        var requestedFile = encodeURIComponent($("#hdnfileDetail").val());
        iframe_.setAttribute("src", baseUrl + 'WebPages/Download.aspx?file=' + requestedFile);

        if (navigator.userAgent.indexOf("MSIE") > -1 && !window.opera) { // Si es Internet Explorer
            iframe_.onreadystatechange = function () {
                switch (this.readyState) {
                    case "loading":
                        waitingDialog({});
                        break;
                    case "complete":
                    case "interactive":
                    case "uninitialized":
                        closeWaitingDialog();
                        break;
                    default:
                        closeWaitingDialog();
                        break;
                }
            };
        }
        else {
            // Si es Firefox o Chrome
            $(iframe_).ready(function () {
                closeWaitingDialog();
            });
        }
        document.body.appendChild(iframe_);
    }

    /*EPD-1025*/
    function fnGrilla() {
        jQuery("#list").jqGrid({
            url: baseUrl + "DescargarPedidos/Consultar",
            hidegrid: false,
            datatype: 'json',
            postData: ({

            }),
            mtype: 'GET',
            contentType: "application/json; charset=utf-8",
            colNames: ['Fecha/Hora Inicio', 'Fecha/Hora Fin', 'Estado', 'Mensaje', 'Número de pedidos', 'Tipo de proceso', 'Fecha Facturación'],
            colModel: [

                { name: 'FechaHoraInicio', index: 'FechaHoraInicio', width: 15, editable: false, resizable: false },
                { name: 'FechaHoraFin', index: 'FechaHoraFin', width: 15, editable: false, resizable: false },
                { name: 'Estado', index: 'Estado', width: 20, editable: false, resizable: true },
                { name: 'NumeroPedidos', index: 'NumeroPedidos', width: 15, editable: true, resizable: false },
                { name: 'TipoProceso', index: 'TipoProceso', width: 10, editable: true, resizable: false },
                { name: 'FechaFacturacion', index: 'FechaFacturacion', width: 0, editable: false, resizable: false, hidden: false }
            ],
            //jsonReader:
            //{
            //    root: "rows",
            //    page: "page",
            //    total: "total",
            //    records: "records",
            //    repeatitems: true,
            //    totalregistros: "totalregistros",
            //    pedidosfacturar: "pedidosfacturar",
            //    cell: "cell",
            //    id: "id"
            //},
            pager: jQuery('#pager'),
            loadtext: 'Cargando datos...',
            recordtext: "{0} - {1} de {2} Registros",
            emptyrecords: 'No hay resultados',
            rowNum: 10,
            scrollOffset: 0,
            rowList: [10, 20, 30, 40, 50],
            sortname: 'FechaHoraInicio',
            sortorder: 'asc',
            viewrecords: true,
            multiselect: false,
            height: 'auto',
            width: 930,
            pgtext: 'Pág: {0} de {1}',
            altRows: true,
            altclass: 'jQGridAltRowClass',
            loadComplete: function () {
            },
            gridComplete: function () { }
        });
        //jQuery("#list").jqGrid('navGrid', "#pager", { edit: false, add: false, refresh: false, del: false, search: false });
        jQuery("#list").setGridParam({ datatype: 'json', page: 1 }).trigger('reloadGrid');

    }
    /*EPD-1025*/
</script>

<div class="wrap_cab">

    <div class="filtros">
        <div class="elements">
            <div class="div-2">
                <h1>Carga de Pedidos</h1>
            </div>
        </div>
    </div>
</div>
<div class="wrap">
    <div class="container clearfix">
        <div class="border-wrapper_reg">

            <div class="div-3">
                <div class="titF">País:</div>
                <div class="selectP2 borde_redondeado">
                    @Html.DropDownListFor(model => model.PaisID, new SelectList(Model.listaPaises, "PaisID", "Nombre"), new { id = "ddlPais" })
                </div>
            </div>

            <div class="div-3">
                <div class="titF">Fecha Facturación:</div>
                <div class="calendar borde_redondeado">
                    <input type="text" id="txtFechaFacturacion" />
                </div>
            </div>

            <div class="div-3">
                <div class="titF">Tipo de Proceso:</div>
                <div class="selectP2 borde_redondeado">
                    @if (ViewBag.NombrePais == "México" || ViewBag.NombrePais == "Costa Rica" || ViewBag.NombrePais == "Guatemala" || ViewBag.NombrePais == "El Salvador" || ViewBag.NombrePais == "Panamá")
                    {
                        <select id="cboTipoCronograma">
                            <option value="0">-- Seleccionar --</option>
                            <option value="1">Regular</option>
                            <option value="2">Demanda Anticipada</option>
                            <option value="3">Demanda Anticipada PRD</option>
                            <option value="4">FIC</option>
                            <option value="5">Generar Líderes</option>
                            <option value="6">Digitacion Distribuida Parcial</option> <!--  R20151003 -->                           
                            @*2382*@
                        </select>
                    }
                    else if (ViewBag.NombrePais == "Puerto Rico" || ViewBag.NombrePais == "República Dominicana")
                    {
                        <select id="cboTipoCronograma">
                            <option value="0">-- Seleccionar --</option>
                            <option value="1">Regular</option>
                            <option value="2">Demanda Anticipada</option>
                            <option value="3">Demanda Anticipada PRD</option>
                            <option value="4">FIC</option>
                            <option value="5">Generar Líderes</option>                        
                            @*2382*@
                        </select>
                    }
                    else
                    {
                        <select id="cboTipoCronograma">
                            <option value="0">-- Seleccionar --</option>
                            <option value="1">Regular</option>
                            <option value="2">Demanda Anticipada</option>
                            <option value="3">Demanda Anticipada PRD</option>                            
                            <option value="5">Generar Líderes</option>
                            @*2382*@                     
                        </select>
                    }
                </div>
            </div>
            <div class="div-3">
                <div class="titF"></div>
                <div class="input_add_alert_left">
                    <input type="button" name="" id="btnDescargar" value="Descargar" />
                </div>
            </div>
            <div id="DivDescargas" class="div-4" style="display:none">
                <div class="noti3">
                    Puede descargar los archivos generados haciendo click en los siguientes enlaces:<br />
                    Cabecera: <a id="Aheader" href="#" onclick="DescargarCabecera()"></a><br />
                    Detalle: <a id="Ddetail" href="#" onclick="DescargarDetalle()"></a><br />
                    
                    Actualización de Datos: <a id="Ddetail1" href="#" onclick="DescargarDetalleAct()"></a>
                </div>
            </div>
            <!-- 2382 -->
            <div id="DivMensajeLideres" class="div-4" style="display: none">
                <div id="DivMensajeNoti" class="noti3">
                    Archivo generado correctamente, se crearon <span id="spCantidad"></span> registros de Líderes.
                    Puede descargar el archivo generado haciendo clic en el siguiente enlace:<br />
                    Archivo de Líderes: <a id="liderHeader" href="#" onclick="DescargarCabecera()" ></a>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="hdnfileHeader" name="hdnfileHeader" />
    <input type="hidden" id="hdnfileDetail" name="hdnfileDetail" />
    <input type="hidden" id="hdnfileDetailAct" name="hdnfileDetailAct" />


</div>
<div class="wrap">
    <div class="container clearfix">
        <div class="border-wrapper">
            <table id="list"></table>
            <div id="pager"></div>
        </div>
    </div>
</div>
<div id="loadingScreen"></div>
