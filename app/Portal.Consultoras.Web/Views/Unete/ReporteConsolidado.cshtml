@using System.Configuration
@using Portal.Consultoras.Common
@model Portal.Consultoras.Web.Models.ReporteConsolidadoModel

@{
    ViewBag.Title = "Reporte Consolidado";
    Layout = "~/Views/Shared/_SACLayout.cshtml";
}

<script async defer type="text/javascript" src="https://maps-api-ssl.google.com/maps/api/js?v3.exp"></script>

<style>
    .ui-widget-content.ui-dialog {
        behavior: url('@Url.Content("~/Content/Css/Pie/PIE.htc)")') !important;
    }
</style>
<style>
    .ui-jqgrid .ui-jqgrid-htable {
        table-layout: fixed;
        margin: 0em;
    }

    .ui-jqgrid .ui-jqgrid-btable {
        table-layout: fixed;
        margin: 0em;
        outline-style: none;
    }

    .ui-jqgrid .ui-jqgrid-ftable {
        table-layout: fixed;
        margin-bottom: 0em;
    }

    .ui-datepicker-trigger {
        cursor: pointer;
    }

    .ui-widget-header {
        height: 20px !important;
    }

    .modal_base {
        padding-left: 0 !important;
    }

        .modal_base .content {
            box-sizing: border-box;
            behavior: url('/Content/Css/Pie/PIE.htc)');
            z-index: 1000000;
        }

            .modal_base .content h2 {
                padding: 0 30px;
            }

            .modal_base .content .elements {
                width: 95% !important;
                padding-top: 25px !important;
            }

    .div-3 .titC {
        width: 140px !important;
    }

    .width_150 {
        width: 150px;
    }

    #Estado {
        width: 100%;
    }
</style>
@Html.HiddenFor(m => Model.PrefijoISOPais)

<div class="wrap_cab">
    <div class="filtros2">
        <div class="elements">
            <div class="div-2">
                <h1>Reporte Consolidado Unete</h1>
            </div>
            <div class="div-3">
                <div class="titC width_150">Fecha Desde:</div>
                <div class="selectP2 borde_redondeado calendar">
                    @Html.TextBoxFor(m => Model.FechaDesde)
                </div>
                <div class="titC width_150">Fecha hasta:</div>
                <div class="selectP2 borde_redondeado calendar">
                    @Html.TextBoxFor(m => Model.FechaHasta)
                </div>
            </div>

            <div class="div-3">
                <div class="titC width_150">Region:</div>
                <div class="selectP2 borde_redondeado">
                    @Html.TextBoxFor(m => Model.Region, new {@style = "text-transform: uppercase;"})
                </div>
                <div class="titC width_150">Seccion:</div>
                <div class="selectP2 borde_redondeado">
                    @Html.TextBoxFor(m => Model.Seccion, new { @style = "text-transform: uppercase;" })
                </div>
            </div>
            <div class="div-3">
                <div class="titC width_150">Zona:</div>
                <div class="selectP2 borde_redondeado calendar">
                    @Html.TextBoxFor(m => Model.Zona, new { @style = "text-transform: uppercase;" })
                </div>
                @*<div class="titC width_150">Zona:</div>
                <div class="selectP2 borde_redondeado calendar">
                    @Html.TextBoxFor(m => Model.Zona, new { @style = "text-transform: uppercase;" })
                </div>*@
            </div>

            <div class="div-3">
                <div class="titC width_150"></div>
                <div class="input_search">
                    <input type="submit" name="" id="btnBuscar" value="Buscar" />
                </div>
            </div>
        </div>
    </div>
</div>


<div class="wrap" id="data">
    <div class="container clearfix" style="margin-left: 850px">
        <div class="input_global">
            <img src="@Url.Content("~/Content/HojaInscripcion/images/excel-xls-icon.png")" onclick="ExportExcel();" style="cursor: pointer; width: 64px; height: 64px" />

        </div>
    </div>
    <div class="container clearfix" style="width: 750px;">
        <div class="border-wrapper" id="tablaReporteConsolidado" style="overflow-x: hidden" align="center" >
            <table id="gvwReporteConsolidado" ></table>
            <div id="pager"></div>
        </div>
    </div>
</div>
<div id="loadingScreen"></div>
<div id="modal_general" class="modal_base" style="display: none;">
    <div class="content" id="modal_content">
    </div>
</div>

<div id="modal_opcion" class="modal_base" style="display: none;">
    <div class="content" id="modal_opcion_content">
    </div>
</div>

<div id="modal_enviado" class="modal_base" style="display: none; overflow: hidden;">
    <div class="content" id="modal_env">
        <div class="wrap_cab">
            <div class="filtros2">
                <div class="div-2" style="text-align: center;">
                    <h2>
                        ¡ENVIADO!
                        <img id="imgCerrar" src="@Url.Content("~/Content/Images/btnCerrar_AD.png")" class="float_rigth" style="cursor: pointer;" />
                    </h2>
                </div>
            </div>
        </div>
        <div class="elements">
            <div class="div-3" style="text-align: center;">
                El correo fue enviado con éxito
            </div>
        </div>
    </div>
</div>

<script>
    var colNames = [
        'Descripcion',
        'MovilSE',
        'PortalGZ',
        'UB',
        'ACC',
         'Totales'
    ];

    function fnGrilla() {
        jQuery("#gvwReporteConsolidado").jqGrid({
            url: '@Url.Action("ConsultarReporteConsolidado", "Unete")',
            hidegrid: false,
            datatype: 'json',
            postData: ({
                PrefijoISOPais: function () { return $("#PrefijoISOPais").val(); },
                FechaDesde: function () { return $("#FechaDesde").val(); },
                FechaHasta: function () { return $("#FechaHasta").val(); },
                Region: function () { return $("#Region").val(); },
                Zona: function () { return $("#Zona").val(); },
                Seccion: function () { return $("#Seccion").val(); }

            }),
            mtype: 'POST',
            contentType: "application/json; charset=utf-8",
            colNames: colNames,
            colModel: [
              { name: 'Descripcion', index: 'Descripcion', width: 20, editable: false,resizable: false, align: 'center' },
              { name: 'MovilSE', index: 'MovilSE', width: 9, editable: false, resizable: false, align: 'center' },
              { name: 'PortalGZ', index: 'PortalGZ', width: 9, editable: false, resizable: false, align: 'center' },
              { name: 'UB', index: 'UB', width: 9, editable: false, resizable: false, align: 'center' },
              { name: 'ACC', index: 'ACC', width: 9, editable: false, resizable: false, align: 'center' },
              { name: 'Totales', index: 'Totales', width: 9, editable: false, resizable: false, align: 'center' }
            ],
            jsonReader:
               {
                   root: "rows",
                   page: "page",
                   total: "total",
                   records: "records",
                   repeatitems: true,
                   cell: "cell"
               },
            pager: jQuery('#pager'),
            loadtext: 'Cargando datos...',
            recordtext: "{0} - {1} de {2} Registros",
            emptyrecords: 'No hay resultados',
            rowNum: 10,
            scrollOffset: 0,
            rowList: [10, 20, 30, 40, 50],
            //sortname: 'FechaCreacion',
            //sortorder: 'desc',
            viewrecords: true,
            multiselect: false,
            height: 'auto',
            width: 530,
            shrinkToFit: true,
            pgtext: 'Pág: {0} de {1}',
            altRows: true,
            altclass: 'jQGridAltRowClass',
            loadComplete: function () {

            },
            gridComplete: function () {
                jQuery("#gvwReporteConsolidado").jqGrid('showCol', 'Descripcion');
                jQuery("#gvwReporteConsolidado").jqGrid('showCol', 'MovilSE');
                jQuery("#gvwReporteConsolidado").jqGrid('showCol', 'PortalGZ');
                jQuery("#gvwReporteConsolidado").jqGrid('showCol', 'UB');
                jQuery("#gvwReporteConsolidado").jqGrid('showCol', 'ACC');
                jQuery("#gvwReporteConsolidado").jqGrid('showCol', 'Totales');
            }
        });
        jQuery("#gvwReporteConsolidado").jqGrid('navGrid', "#pager", { edit: false, add: false, refresh: false, del: false, search: false });
        jQuery("#gvwReporteConsolidado").setGridParam({ datatype: 'json', page: 1 }).trigger('reloadGrid');

    }
    //Exportar a Excel

    function ExportExcel() {
        var m = true;
        if ($("#gvwReporteConsolidado").getGridParam("reccount") == 0) {
            m = confirm('La grilla se encuentra vacía.\n¿ Está seguro(a) que desea continuar con la operación ?');
        }
        if (!m) {
            return;
        }
        var PrefijoISOPais = $("#PrefijoISOPais").val();
        var FechaDesde = $("#FechaDesde").val();
        var FechaHasta = $("#FechaHasta").val();
        var Region = $("#Region").val();
        var Zona = $("#Zona").val();
        var Seccion = $("#Seccion").val();




      
        //var Nombre = $('#Nombre').val();
        //var Estado = $("#Estado").val();
        //var DocumentoIdentidad = $("#DocumentoIdentidad").val();
        //var codigoZonaFiltro = $("#CodigoZonaFiltro").val();

        //var vmessage = "";
        //if (Estado == "")
        //    vmessage += "Debe seleccionar un Estado. \n";
        ////if (vCampaniaID == "")
        ////    vmessage += "Debe seleccionar la Campaña \n";

        waitingDialog({});

        setTimeout(function () {
            DownloadAttachExcel(PrefijoISOPais, FechaDesde, FechaHasta, Region, Zona, Seccion);
        }, 0);
    }

    function DownloadAttachExcel(PrefijoISOPais, FechaDesde, FechaHasta, Region, Zona, Seccion) {
        var content = baseUrl +
            "Unete/ExportarExcelReporteConsolidado?" +
            "PrefijoISOPais=" +
            PrefijoISOPais +
            "&FechaDesde=" +
            FechaDesde +
            "&FechaHasta=" +
            FechaHasta + 
            "&Region=" +
            Region +
            "&Zona=" +
            Zona +
            "&Seccion=" +
            Seccion;

        var iframe_ = document.createElement("iframe");
        iframe_.style.display = "none";
        iframe_.setAttribute("src", content);

        if (navigator.userAgent.indexOf("MSIE") > -1 && !window.opera) { // Si es Internet Explorer
            iframe_.onreadystatechange = function () {
                switch (this.readyState) {
                    case "loading":
                        waitingDialog({});
                        break;
                    case "complete":
                    case "interactive":
                    case "uninitialized":
                        closeWaitingDialog();
                        break;
                    default:
                        closeWaitingDialog();
                        break;
                }
            };
        }
        else {
            // Si es Firefox o Chrome
            $(iframe_).ready(function () {
                closeWaitingDialog();
            });
        }
        document.body.appendChild(iframe_);
    }

    function IntegerNumber(e) {
        // Allow: backspace, delete, tab, escape, enter
        if ($.inArray(e.keyCode, [46, 8, 9, 27, 13]) !== -1 ||
            // Allow: Ctrl+A
            (e.keyCode == 65 && e.ctrlKey === true) ||
            // Allow: home, end, left, right
            (e.keyCode >= 35 && e.keyCode <= 39)) {
            // let it happen, don't do anything
            return true;
        }

        // Allow copy, cut and don't allow paste
        var ctrlDown = e.ctrlKey || e.metaKey; // Mac support
        if (ctrlDown && e.altKey) return true;
        else if (ctrlDown && e.keyCode == 67) return true; // c
        else if (ctrlDown && e.keyCode == 86) return false; // v
        else if (ctrlDown && e.keyCode == 88) return true; // x

        // Ensure that it is a number and stop the keypress
        if ((e.shiftKey || e.altKey || e.ctrlKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
        }
    }

    function Text(e) {
        var key = e.keyCode;

        if ($.inArray(e.keyCode, [46, 8, 9, 27, 13]) !== -1 ||
            (e.keyCode >= 35 && e.keyCode <= 39)) {
            return true;
        } else {
            if ((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105)) {
                return false;
            } else {
                var RegExpression = /^[a-zA-ZñáéíóúÑÁÉÍÓÚäëïöüÄËÏÖÜ\s]*$/;
                return RegExpression.test(String.fromCharCode(key));
            }
        }
    }
    $('#imgCerrar').click(function () {
        modalEnviado.dialog('close');
    });
    var modal, modalOpcion, modalEnviado;

    $(function () {

        $('#Seccion').change(function () {
            var zona = $('#Zona').val();
            if (zona.length == 0) {
                $('#Zona').prop('required', true);
            }
        });

        $('#btnBuscar').click(function (e) {
            var fechaInicio = $('#FechaDesde').val();
            var fechaFin = $('#FechaHasta').val();
            var region = $('#Region').val();
            var zona = $('#Zona').val();
            var seccion =$('#Seccion').val();
            if (fechaInicio.length > 0 && fechaFin.length > 0) {
                if (seccion.length > 0 && zona.length ==0) {
                    alert('Debe ingresar una zona');
                } else if (
                        (region.length == 0 && zona.length == 0 && seccion.length == 0) ||
                        (region.length > 0 && seccion.length == 0 && zona.length == 0) ||
                        (zona.length > 0 && seccion.length == 0 && region.length == 0) ||
                        (zona.length > 0 && zona.length > 0 && seccion.length ==0 ) ||
                        (seccion.length > 0) 
                    ) {
                    fnGrilla();
                    e.preventDefault();
                    console.info(e.target);
                }
            } else {
                alert('Debe ingresar una fecha!');
            }

            
        });

        $("#FechaDesde, #FechaHasta").datepicker({
            showOn: "button",
            buttonImage: '@Url.Content("~/Content/Images/calendar.png")',
            buttonImageOnly: true,
            dateFormat: 'dd/mm/yy'
        }).mask('99/99/9999');

        fnGrilla();

        modal = $("#modal_general").dialog({
            autoOpen: false,
            dialogClass: "loadingScreenWindow",
            closeOnEscape: true,
            draggable: true,
            width: 350,
            minHeight: 50,
            height: 100,
            modal: true,
            buttons: {},
            resizable: false,
            open: function () {
                $('body').css('overflow', 'hidden');
            },
            close: function () {
                $('body').css('overflow', 'auto');
            }
        });

        modalOpcion = $("#modal_opcion").dialog({
            autoOpen: false,
            dialogClass: "loadingScreenWindow",
            closeOnEscape: true,
            draggable: true,
            width: 350,
            minHeight: 50,
            modal: true,
            buttons: {},
            resizable: false,
            open: function () {
                $('body').css('overflow', 'hidden');
            },
            close: function () {
                $('body').css('overflow', 'auto');
            }
        });

        modalEnviado = $("#modal_enviado").dialog({
            autoOpen: false,
            dialogClass: "loadingScreenWindow",
            closeOnEscape: true,
            draggable: true,
            width: 350,
            minHeight: 50,
            modal: true,
            buttons: {},
            resizable: false,
            open: function () {
                $('body').css('overflow', 'hidden');
            },
            close: function () {
                $('body').css('overflow', 'auto');
            }
        });
    });
</script>