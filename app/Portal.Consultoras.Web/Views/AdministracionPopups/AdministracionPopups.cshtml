@model Portal.Consultoras.Web.Models.AdministracionPoput.ComunicadoModel
@{
    ViewBag.Title = "Administración de Popups";
}

<link href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i" rel="stylesheet">
<link href="@Url.Content("~/Content/Css/Site/AdministracionPopups/administracion-popups.css")" rel="stylesheet" />

<!-- VISTA ADMINISTRACIÓN DE POPUPS -->
<main class="d__block layout__content w__100 ml__auto mr__auto vista__administracion__popups">
    <!-- CABECERA ADMINISTRACIÓN DE POPUPS -->
    <section class="d__block ml__auto mr__auto vista__administracion__popups__cabecera">
        <h1 class="d__block color__m text__bold vista__administracion__popups__titulo">
            Administración de Popups
        </h1>
        <div class="d__block administracion__popups__grilla__filtros">
            <div class="d__inline__block grupo__form__grilla__filtros">
                <label for="ddlCampania" class="d__inline__block text__bold grilla__filtro__label">Campaña:</label>
                @Html.DropDownListFor(model => model.CampaniaID, new SelectList(Model.listaCampania, "CampaniaID", "NombreCorto"), "-- Seleccionar --", new { @class = "d__inline__block text__bold border__color__gray__multimarca border__radius__4 grilla__filtro__campo grilla__filtro__select", @id = "ddlCampania" })
            </div>
            <div class="d__inline__block grupo__form__grilla__filtros">
                <label for="ddlEstado" class="d__inline__block text__bold grilla__filtro__label">Estado:</label>
                <select id="ddlEstado" class="d__inline__block text__bold border__color__gray__multimarca border__radius__4 grilla__filtro__campo grilla__filtro__select">
                    <option value="2">Todos</option>
                    <option value="1">Activo</option>
                    <option value="0">Inactivo</option>
                </select>
            </div>

            <div class="d__inline__block grupo__form__grilla__filtros">
                <div class="d__inline__block text__bold grilla__filtro__label">Nuevo Popup:</div>
                <a class="d__inline__block text__bold text__center background__color__m border__radius__4 btn__grilla__filtros btn__agregar" AccionId="1" title="Agregar Nuevo Popup">
                    <span class="d__inline__block text__bold">+</span>
                    <span class="d__inline__block text__bold">Agregar</span>
                </a>
            </div>
        </div>
    </section>
    <!-- FIN - CABECERA ADMINISTRACIÓN DE POPUPS -->
    <!-- GRILLA ADMINISTRACIÓN DE POPUPS -->
    <section class="d__block border__radius__4 vista__administracion__popups__contenido">
        <div class="d__flex administracion__popups__paginacion__grilla">
            <div class="d__flex administracion__popups__paginacion__componentes">
                <div class="d__block cantidad__registros__grilla">
                </div>
                <div class="d__flex paginador__grilla">
                    <div class="d__block">Página</div>
                    <div class="d__flex controles__paginacion__grilla">
                        <a id="izquierdaArriba" class="d__block flecha__paginacion flecha__paginacion--izquierda" title="Página Anterior">
                            <img src="@Url.Content("~/Content/Images/flecha-campo-select.svg")" alt="Anterior">
                        </a>
                        <div class="d__block filtro__num__pagina">
                            <input id="PaginaActualArriba" onpaste="return false" onkeypress="return FuncionesGenerales.ValidarSoloNumeros(event, this, true);" class="d__inline__block text__center border__color__gray__multimarca border__radius__4 paginacion__actual" value="1" type="text">
                            <span class="d__inline__block num__total__paginas"></span>
                        </div>
                        <div id="derechaArriba" class="d__block flecha__paginacion flecha__paginacion--derecha" title="Página Siguiente">
                            <img src="@Url.Content("~/Content/Images/flecha-campo-select.svg")" alt="Siguiente">
                        </div>
                    </div>
                </div>
            </div>
            <a class="d__block text__bold text__center background__color__m border__radius__4 btn__grilla__filtros btn__guardar__ordenamiento" title="Guardar ordenamiento" id="btnActualizaOrden" style="display:none;cursor:pointer;">
                Guardar ordenamiento
            </a>
        </div>
        <div class="d__block administracion__popups__grilla" id="divTabla">
        </div>
        <div class="d__flex administracion__popups__paginacion__grilla">
            <div id="" class="d__block cantidad__registros__grilla">

            </div>
            <div class="d__flex paginador__grilla">
                <div class="d__block">Página</div>
                <div class="d__flex controles__paginacion__grilla">
                    <a id="izquierdaAbajo" class="d__block flecha__paginacion flecha__paginacion--izquierda" title="Página Anterior">
                        <img src="@Url.Content("~/Content/Images/flecha-campo-select.svg")" alt="Anterior">
                    </a>
                    <div class="d__block filtro__num__pagina">
                        <input id="PaginaActualAbajo" onpaste="return false" onkeypress="return FuncionesGenerales.ValidarSoloNumeros(event, this, true);" class="d__inline__block text__center border__color__gray__multimarca border__radius__4 paginacion__actual" value="1" type="text">
                        <span class="d__inline__block num__total__paginas"></span>
                    </div>
                    <a id="derechaAbajo" class="d__block flecha__paginacion flecha__paginacion--derecha" title="Página Siguiente">
                        <img src="@Url.Content("~/Content/Images/flecha-campo-select.svg")" alt="Siguiente">
                    </a>
                </div>
            </div>
        </div>
    </section>
    <!-- FIN - GRILLA ADMINISTRACIÓN DE POPUPS -->
</main>

<!-- MODAL AGREGAR NUEVO POPUP -->
<section class="d__flex w__100 modal__bg" id="AgregarPopup">
    <input type="hidden" id="hdAccion" value="" />
    <input type="hidden" id="hdComunicadoId" />
    <div class="d__block w__100 ml__auto mr__auto modal__wrapper">
        <header class="d__block modal__cabecera">
            <h2 class="d__block color__m text__bold modal__titulo" id="modalTitulo"></h2>
        </header>
        <section class="d__block modal__contenido modal__contenido--agregarNuevoPopup">
            <div class="d__block modal__contenido__seccion">
                <h4 class="d__block text__bold text__uppercase modal__contenido__subtitulo">Contenido</h4>
                <div class="d__flex modal__contenido__seccion__campos modal__contenido__seccion__campos--contenido">
                    <div class="d__flex grupo__form__campos--agregarArchivos">
                        <div class="d__block color__m text__bold grupo__form__campos__label grupo__form__campos__label--adjuntarFondo">Adjuntar Fondo : </div>
                        <div class="d__block mr-20">
                            <input id="imgPoputs" type="file" class="d__none text__bold" />
                            <label for="imgPoputs" class="d__block text__bold text__center background__color__m border__radius__4 btn__modal btn__modal--agregar" title="Agregar nuevo popup">
                                <span class="d__inline__block text__bold">+</span>
                                <span class="d__inline__block text__bold">Agregar</span>
                            </label>
                            <div class="caption">
                                <a href="#"><i class="glyphicon glyphicon-trash"></i></a>
                                <p id="description" class="d__block color__gray__multimarca info__formato__medidas">
                                    Formato de archivo JPG.<br />
                                    (326 x 418 píxeles)
                                </p>
                            </div>
                        </div>
                        <div id="imgPreview" class="d__block imagen__cargada__thumbnail__wrapper" style="display:none;">
                            <div onclick="ClearFileView(this)" title="Eliminar" class="d__block enlace__eliminar__imagen__cargada">
                                <img src="@Url.Content("~/Content/Images/btn_cerrar_popup.svg")" alt="Eliminar Imagen" class="d__block m-0" />
                            </div>
                            <img class="d__block m-0 w__100 imagen__cargada__thumbnail" id="targetImg" />
                        </div>
                    </div>
                    <div class="d__flex grupo__form__campos">
                        <label for="txtTituloPrincipal" class="d__block text__bold color__m grupo__form__campos__label">Título principal : </label>
                        <input id="txtTituloPrincipal" onkeypress="return FuncionesGenerales.ValidarSoloLetrasYNumeros(event, this, true);" type="text" class="d__block border__color__gray__multimarca border__radius__4 grupo__form__campos__input grupo__form__campos__input--seccionContenido" />
                    </div>
                    <div class="d__flex grupo__form__campos">
                        <label for="txtDescripcion" class="d__block text__bold color__m grupo__form__campos__label grupo__form__campos__label--descripcion">Descripción<br />(max de caract. 290) : </label>
                        <textarea id="txtDescripcion" onkeypress="return FuncionesGenerales.ValidarSoloLetrasYNumeros(event, this, true);" class="d__block border__color__gray__multimarca border__radius__4 grupo__form__campos__textarea grupo__form__campos__textarea--seccionContenido"></textarea>
                    </div>
                    <div class="d__flex mb-40 grupo__form__campos">
                        <label for="txtUrl" class="d__block text__uppercase text__bold color__m grupo__form__campos__label">Url : </label>
                        <input id="txtUrl" type="text" class="d__block border__color__gray__multimarca border__radius__4 grupo__form__campos__input grupo__form__campos__input--seccionContenido" />
                    </div>
                </div>
            </div>
            <div class="d__block modal__contenido__seccion">
                <h4 class="d__block text__bold text__uppercase modal__contenido__subtitulo">Configuración</h4>
                <div class="d__flex modal__contenido__seccion__campos modal__contenido__seccion__campos--configuracion">

                    <div class="d__flex grupo__form__campos--agregarArchivos">
                        <div class="d__block text__bold color__m grupo__form__campos__label grupo__form__campos__label--segmentoConsultoras">Segmento de<br />consultoras : </div>
                        <div class="d__block">
                            <input id="fileCSV" type="file" class="d__none text__bold" onchange='getFileCSV()' />
                            <label for="fileCSV" class="d__block text__bold text__center background__color__m border__radius__4 btn__modal btn__modal--agregar">
                                <span class="d__inline__block text__bold">+</span>
                                <span class="d__inline__block text__bold">Agregar</span>
                            </label>
                            <p class="d__block color__gray__multimarca info__formato__medidas" id="nameArchivo">

                            </p>
                        </div>
                        <div id="EliminarArchivo" class="d__block csv__cargado__thumbnail__wrapper" style="display:none;">
                            <div title="Eliminar" class="d__block enlace__eliminar__csv__cargado eliminarArchivo">
                                <img src="@Url.Content("~/Content/Images/btn_cerrar_popup.svg")" alt="Eliminar archivo CSV" class="d__block m-0" />
                            </div>
                            <img class="d__block m-0 w__100 csv__cargado__thumbnail" src="@Url.Content("~/Content/Images/csv_file_img.svg")" alt="" />
                        </div>

                    </div>

                    <div class="d__flex grupo__form__campos">
                        <label class="d__block text__bold color__m grupo__form__campos__label">Duración : </label>
                        <div class="d__flex mb-0 grupo__form__campos grupo__form__campos--minMax">
                            <label for="fechaMin" class="d__block text__bold grupo__form__campos__label grupo__form__campos__label--minMax">Min</label>
                            <input id="fechaMin" autocomplete="off" type="text" placeholder="mm/dd/aa" class="d__block border__color__gray__multimarca border__radius__4 grupo__form__campos__input grupo__form__campos__input--minMax" />
                        </div>
                        <div class="d__flex mb-0 grupo__form__campos grupo__form__campos--minMax">
                            <label for="fechaMax" class="d__block text__bold grupo__form__campos__label grupo__form__campos__label--minMax">Max</label>
                            <input id="fechaMax" autocomplete="off" type="text" placeholder="mm/dd/aa" class="d__block border__color__gray__multimarca border__radius__4 grupo__form__campos__input grupo__form__campos__input--minMax" />
                        </div>
                    </div>
                    <div class="d__flex grupo__form__campos">
                        <label class="d__block text__bold color__m grupo__form__campos__label">Duración : </label>
                        <div class="d__flex mb-0 grupo__form__campos grupo__form__campos--mobileDesktop">
                            <input id="checkMobile" type="checkbox" class="d__none border__color__gray__multimarca border__radius__4 grupo__form__campos__input" />
                            <label for="checkMobile" class="d__flex grupo__form__campos__label grupo__form__campos__label--conCheckbox">
                                <span class="d__inline__block text__bold">Mobile</span>
                                <span class="d__inline__block border__color__gray__multimarca border__radius__4 grupo__form__campos__checkbox"></span>
                            </label>
                        </div>
                        <div class="d__flex mb-0 grupo__form__campos grupo__form__campos--mobileDesktop">
                            <input id="checkDesktop" type="checkbox" class="d__none border__color__gray__multimarca border__radius__4 grupo__form__campos__input" />
                            <label for="checkDesktop" class="d__flex grupo__form__campos__label grupo__form__campos__label--conCheckbox">
                                <span class="d__inline__block text__bold">Desktop</span>
                                <span class="d__inline__block border__color__gray__multimarca border__radius__4 grupo__form__campos__checkbox"></span>
                            </label>
                        </div>
                    </div>
                    <div class="d__flex grupo__form__campos grupo__form__campos--botones">
                        <button id="btnDescartar" class="d__block text__bold btn__modal mr-25 border__radius__4 btn__modal--blanco btn__modal--descartar">
                            Descartar
                        </button>
                        <button id="btnGuardar" class="d__block text__bold background__color__m border__radius__4 btn__modal btn__modal--guardar">
                            Guardar
                        </button>
                    </div>
                </div>
            </div>

        </section>
    </div>
</section>

<!-- FIN - MODAL AGREGAR NUEVO POPUP -->
<!-- FIN - VISTA ADMINISTRACIÓN DE POS -->
@section scripts{

    <script type="text/javascript">
        var URL_BUSCAR_POPUTS = baseUrl + 'AdministracionPopups/GetCargaListadoPoput';
        var PAGINAS = parseInt($("#PaginaActualArriba").val());
        localStorage.setItem('PAGINAS', PAGINAS);
        var FILAS = parseInt('@ViewBag.NumeroFila');
        var LIMITE_PAGINAS;


        $(document).ready(function () {
           GetCargaListadoPoput();
            $("#PaginaActualArriba, #PaginaActualAbajo").blur(function () {

                if (document.getElementById(this.id).value == "0")
                    document.getElementById(this.id).value = 1;
            });


            $('#ddlCampania, #ddlEstado').change(function () {
                GetCargaListadoPoput();
            });

            function GetCargaListadoPoput() {
              
                waitingDialog({ "title": "Cargando", "message": "Espere por favor" });
                var ddlCampania = $('#ddlCampania').val();
                var ddlEstado = parseInt($('#ddlEstado').val());

                var object = {
                    Campania: ddlCampania,
                    Estado: ddlEstado,
                    Paginas: parseInt( localStorage.getItem('PAGINAS')),
                    Filas: FILAS
                };

                $.ajax({
                    type: "POST",
                    url: URL_BUSCAR_POPUTS,
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(object),
                    dataType: "json",
                    cache: true,
                    success: function (data) {
                        if (data["listaComunicadoModel"].length == 0) alert("La consulta no arrojó ningún resultado");
                        LIMITE_PAGINAS = parseInt(data["Paginamaximas"]);
                        ConstruyeGrillaPoput(data["listaComunicadoModel"]);
                        closeWaitingDialog();
                    },
                    error: function (x, xh, xhr) {
                        if (checkTimeout(x)) {
                            closeWaitingDialog();
                        }
                    }
                });
            }


            function ConstruyeGrillaPoput(data) {

                $("#divTabla").empty();
                $(".cantidad__registros__grilla").html("Tengo <span class='text__bold'>" + data.length + "</span> registro" + (data.length > 1 ? "s" : ""));
                $(".num__total__paginas").html("de " + LIMITE_PAGINAS)

                if (LIMITE_PAGINAS == 0) {

                    document.getElementById("PaginaActualArriba").disabled = true;
                    document.getElementById("PaginaActualAbajo").disabled = true;
                    document.getElementById("PaginaActualArriba").value = LIMITE_PAGINAS;
                    document.getElementById("PaginaActualAbajo").value = LIMITE_PAGINAS;
                    $("#derechaArriba").addClass("disabledbutton");
                    $("#izquierdaArriba").addClass("disabledbutton");
                    $("#derechaAbajo").addClass("disabledbutton");
                    $("#izquierdaAbajo").addClass("disabledbutton");
                } else {
                    if (PAGINAS > LIMITE_PAGINAS) {
                        document.getElementById("PaginaActualArriba").disabled = false;
                        document.getElementById("PaginaActualAbajo").disabled = false;
                        document.getElementById("PaginaActualArriba").value = LIMITE_PAGINAS;
                        document.getElementById("PaginaActualAbajo").value = LIMITE_PAGINAS;
                    } else {
                        document.getElementById("PaginaActualArriba").disabled = false;
                        document.getElementById("PaginaActualAbajo").disabled = false;
                        document.getElementById("PaginaActualArriba").value = PAGINAS;
                        document.getElementById("PaginaActualAbajo").value = PAGINAS;
                    }
                    $("#derechaArriba").removeClass("disabledbutton");
                    $("#izquierdaArriba").removeClass("disabledbutton");
                    $("#derechaAbajo").removeClass("disabledbutton");
                    $("#izquierdaAbajo").removeClass("disabledbutton");

                }



                var listColumnas = [
                    {
                        tituloColumna: 'Orden',
                        claseColumna: 'col__grilla--numero'
                    },
                    {
                        tituloColumna: 'Fondo',
                        claseColumna: 'col__grilla--fondo'
                    },
                    {
                        tituloColumna: 'Duración',
                        claseColumna: 'col__grilla--duracion'
                    },
                    {
                        tituloColumna: 'Título',
                        claseColumna: 'col__grilla--titulo'
                    },
                    {
                        tituloColumna: 'Ruta',
                        claseColumna: 'col__grilla--ruta'
                    },
                    {
                        tituloColumna: 'Estado',
                        claseColumna: 'col__grilla--estado'
                    },
                    {
                        tituloColumna: 'Editar',
                        claseColumna: 'col__grilla--editar'
                    }
                ];

                /*Cabecera*/
                var cantidadPoputs = "<h2 class='d__block text__bold administracion__popups__grilla__titulo'>" + (parseInt(data.length) + (data.length == 1 ? " Poput" : " Poputs") + " agregados") + "</h2 >";
                var cabecera = "<div class='background__color__m row__grilla administracion__popups__grilla__cabecera'>";
                listColumnas.forEach(function (element) {
                    cabecera += "<div class='col__grilla " + (element.claseColumna).toString() + " text__center'>" + (element.tituloColumna).toString() + "</div>";
                });
                cabecera += "</div>";

                /*Detalle*/
                var detalle = "<div id='swappable' class='d__block administracion__popups__grilla__contenido'>";
                for (var i = 0; i < data.length; i++) {
                    detalle += "<div   comunicadoID='" + data[i].ComunicadoId + "' orden='" + data[i].Numero + "' class='d__block background__color__m__lighter ui-state-default row__grilla'>";
                    detalle += "<div class='col__grilla col__grilla--numero'><div class='row__grilla row__grilla__texto text__center' >" + data[i].Numero + "</div ></div >";
                    detalle += "<div class='col__grilla col__grilla--fondo'><div class='row__grilla row__grilla__texto text__center' >" + data[i].NombreImagen + "</div ></div >";
                    detalle += "<div class='col__grilla col__grilla--duracion'><div class='row__grilla row__grilla__texto text__center' >" + (data[i].FechaInicio_ + "-" + data[i].FechaFin_) + "</div ></div >";
                    detalle += "<div class='col__grilla col__grilla--titulo'><div class='row__grilla row__grilla__texto text__center' >" + data[i].Titulo + "</div ></div >";
                    detalle += "<div class='col__grilla col__grilla--ruta'><div class='row__grilla row__grilla__texto text__center' ><a target='blank' href=" + data[i].DescripcionAccion + "  class='d__block'>" + data[i].DescripcionAccion + "</a></div ></div >";
                    detalle += "<div class='col__grilla col__grilla--estado'><div class='row__grilla row__grilla__texto text__center' >" + (data[i].Activo ? "Activo" : "Inactivo") + "</div ></div >";
                    detalle += "<div class='col__grilla col__grilla--editar'><div class='row__grilla row__grilla__texto text__center' ><a href='' title='Editar Popup' class='d__block enlace__editar'><img ComunicadoId=" + data[i].ComunicadoId.toString() + " src=" + "@Url.Content("~/Content/Images/Edit.png") alt='Editar' title='Editar Popup' class='d__block'></a></div></div >";
                    detalle += "</div>";
                }
                detalle += "</div>";
                $("#divTabla").append(cabecera + detalle);
                VistaAdministracionPopups.Funciones.OrdenamientoPersonalizadoFilasGrilla();
            }

            $(".flecha__paginacion--izquierda").click(function () {

                /*MOVIMIENTO IZQUIERDA*/
                PAGINAS = parseInt( localStorage.getItem('PAGINAS'));
                PAGINAS -= 1
                ActualizaPaginador(PAGINAS);
            });

            $(".flecha__paginacion--derecha").click(function () {
                /*MOVIMIENTO IZQUIERDA*/
                PAGINAS = parseInt(localStorage.getItem('PAGINAS'));
                PAGINAS += 1
                ActualizaPaginador(PAGINAS);
            });

            $("#PaginaActualArriba").blur(function () {

                PAGINAS = document.getElementById(this.id).value
                ActualizaPaginador(PAGINAS);
            });

            $("#PaginaActualAbajo").blur(function () {

                PAGINAS = document.getElementById(this.id).value
                ActualizaPaginador(PAGINAS);
            });

            $("#btnActualizaOrden").click(function () {
                ActualizarOrden();
            });






            function ActualizarOrden() {
              
                waitingDialog({ "title": "Cargando", "message": "Espere por favor" });
                var lista = document.querySelector("#swappable");
                var comunicado="";
                var orden = "";

                for (var i = 0; i < lista.childElementCount; i++) {
                    var elemento = lista.children[i];
                    comunicado += lista.children[i].getAttribute("comunicadoid") + "#"  ;
                    orden += lista.children[i].getAttribute("orden")  +  "#"  ;
                }
                    comunicado = comunicado.length > 0 ? comunicado.substring(0, comunicado.length - 1) :'0#';
                    orden = orden.length > 0 ? orden.substring(0, orden.length - 1) : '0#';


                var object = {
                    Comunicado: comunicado,
                    Orden: orden,
                };

                $.ajax({
                    type: "POST",
                    url: URL_ACTUALIZA_ORDEN,
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(object),
                    dataType: "json",
                    async: true,
                    success: function (data) {
                        document.getElementById("btnActualizaOrden").style.display = "none";
                        window.location.reload(true);
                    },
                    error: function (x, xh, xhr) {
                        if (checkTimeout(x)) {
                            closeWaitingDialog();
                        }
                    }
                });
            }



            function ActualizaPaginador(PAGINAS) {

                if (PAGINAS <= 0) {
                    localStorage.setItem('PAGINAS', 1);
                    document.getElementById("PaginaActualArriba").value = 1;
                    document.getElementById("PaginaActualAbajo").value = 1;
                    return false;
                }

                if (PAGINAS > LIMITE_PAGINAS) {
                    localStorage.setItem('PAGINAS', LIMITE_PAGINAS);
                    document.getElementById("PaginaActualArriba").value = LIMITE_PAGINAS;
                    document.getElementById("PaginaActualAbajo").value = LIMITE_PAGINAS;
                    return false;
                }

                localStorage.setItem('PAGINAS', PAGINAS);
                document.getElementById("PaginaActualArriba").value = PAGINAS;
                document.getElementById("PaginaActualAbajo").value = PAGINAS;
                GetCargaListadoPoput();

            }
        });


    </script>


    <script src="@Url.Content("~/Scripts/jquery.ui.core.js")"></script>
   @* <script src="@Url.Content("~/Scripts/jquery.ui.widget.js")"></script>*@
    <script src="@Url.Content("~/Scripts/jquery.ui.mouse.js")"></script>
    <script src="@Url.Content("~/Scripts/jquery.ui.sortable.js")"></script>
    <script src="@Url.Content("~/Scripts/jquery.ui.swappable.js")"></script>
    <script src="@Url.Content("~/Scripts/PortalConsultoras/AdminPoput/AdminPoput.js")"></script>
}