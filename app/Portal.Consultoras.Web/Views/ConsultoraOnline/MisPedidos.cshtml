@model Portal.Consultoras.Web.Models.MisPedidosModel
@{
    ViewBag.Title = "MisPedidos";
}

@System.Web.Optimization.Styles.Render("~/bundles/CSSFuzemodal")

<div class="banner_pedidos">
    <div class="text_bienvenida">
        <h2>BIENVENIDA A <strong>CONSULTORA ONLINE</strong></h2>
        <p class="font_weight_500">A partir de ahora, tu nombre aparecerá en las páginas web de nuestras marcas y nuevos clientes te contactarán.</p>
        <div class="field25 max_width_250 margin_right_5_porc">
            <img src="/Content/Images/ConsultoraOnline/a_txt_llama.png" width="137" height="37" alt="" />
            <p class="margin_left_26 top_menos_6">Recibe la notificación y contacta al cliente.</p>
        </div>
        <div class="field25 max_width_250 margin_right_5_porc">
            <img src="/Content/Images/ConsultoraOnline/b_txt_acepta.png" width="137" height="37" alt="" />
            <p class="margin_left_26 top_menos_6">Acepta el pedido en máximo 24 horas.</p>
        </div>
        <div class="field40 max_width_300">
            <img src="/Content/Images/ConsultoraOnline/c_txt_entrega.png" width="137" height="37" alt="" />
            <p class="margin_left_26 top_menos_6">Entrega el pedido y comienza una relación con tu nuevo cliente.</p>
        </div>
    </div>
</div>
@Html.Partial("_MenuConsultoraOnline")
<div class="cont_pedido tsm">
    <h2>Hola @ViewBag.NombreConsultora,</h2>
    <div id="viewContentHolder">
        @Html.Partial("_ListaPedidos", Model)
    </div>
</div>

<!-------------------------------------------MODALS----------------------------------------------------------->
<!------------------------------------------------------------------------------------------------------------>

<div id="modal_aceptar_pedido" class="fuzemodal tsm" style="display: none">
    <div class="fuzemodal_title">

        <div class="fuzemodal_title_items" onclick="$('#modal_aceptar_pedido').fuzemodal('close');">
            <img src="/Content/Images/ConsultoraOnline/close.png" alt="X" />
        </div>
    </div>
    <div class="fuzemodal_content">

        <img src="/Content/Images/ConsultoraOnline/ic_aceptar.png" alt="" />
        <div id="viewPlaceHolder">
        </div>
    </div>
</div>

<div id="modal_rechazar_pedido" class="fuzemodal tsm" style="display: none">
    <div class="fuzemodal_title">
        <span>¿NOS PUEDES CONTAR LA RAZON <br />POR LA QUE NO ACEPTAS EL PEDIDO?</span>
        <div class="fuzemodal_title_items" onclick="$('#modal_rechazar_pedido').fuzemodal('close'); $('#modal_rechazar_pedido').fuzemodal('close');">
            <img src="/Content/Images/ConsultoraOnline/close.png" alt="X" />
        </div>
    </div>
    <div class="fuzemodal_content">
        <br />
        <br />
        <form id="frmRechazoPedido">
            <input type="hidden" name="SolicitudId" id="SolicitudId" />
            <input type="hidden" name="NumIteracion" id="NumIteracion" />
            <input type="hidden" name="CodigoUbigeo" id="CodigoUbigeo" />
            <input type="hidden" name="Campania" id="Campania" />
            <input type="hidden" name="MarcaID" id="MarcaID" />
            <input type="hidden" name="DivPanelPedidoRechazado" id="DivPanelPedidoRechazado" />
            <div id="wrap_Rechazar_pedido_preguntas">
                <input type="hidden" id="RechazaPedidoId" value="none" />
                <input class="display_none" type="radio" value="1" id="cb21" name="checkbox">
                <label for="cb21">No tengo tiempo para atenderla.</label>
                <input class="display_none" type="radio" value="2" id="cb22" name="checkbox">
                <label for="cb22">El cliente vive muy lejos.</label>
                <input class="display_none" type="radio" value="3" id="cb23" name="checkbox">
                <label for="cb23">El/los productos están agotados en esta campaña.</label>
                <input class="display_none" type="radio" value="4" id="cb24" name="checkbox">
                <label for="cb24">No pasaré pedido esta campaña.</label>
                <input class="display_none" type="radio" value="6" id="cb26" name="checkbox">
                <label for="cb26">Otros</label>
                <textarea name="txtOtrosRechazo" id="txtOtrosRechazo"></textarea>
            </div>
        </form>
        <div class="fuzemodal_buttons clear_co">
            <button id="btnEnviarRechazo" class="boton_morado_2 margin_bottom_45" type="button" onclick="EjecutaRechazoPedido();">ENVIAR</button>
        </div>

    </div>
</div>

<div id="modal_cancelar_pedido" class="fuzemodal tsm" style="display: none">
    <div class="fuzemodal_title">
        <span>CANCELA EL PEDIDO</span>
        <div class="fuzemodal_title_items" onclick="$('#modal_cancelar_pedido').fuzemodal('close');">
            <img src="/Content/Images/ConsultoraOnline/close.png" alt="X" />
        </div>
    </div>
    <div class="fuzemodal_content">
        <p>Cuéntanos por qué tuviste que cancelar el pedido</p>
        <br />
        <form id="frmCancelaPedido">
            <div id="wrap_cancelar_pedido_preguntas">
                <input type="hidden" id="CancelaPedidoId" value="none" />
                <input type="hidden" name="DivPanelPedidoCancelado" id="DivPanelPedidoCancelado" />
                <input type="hidden" name="DivPanelTarget" id="DivPanelTarget" />
                <input class="display_none" type="radio" value="7" id="cb1" name="checkbox">
                <label for="cb1">Yo no puedo atender su pedido.</label>
                <input class="display_none" type="radio" value="8" id="cb2" name="checkbox">
                <label for="cb2">El cliente vive muy lejos.</label>
                <input class="display_none" type="radio" value="9" id="cb3" name="checkbox">
                <label for="cb3">El/los productos están agotados en esta campaña.</label>
                <input class="display_none" type="radio" value="10" id="cb4" name="checkbox">
                <label for="cb4">No pasaré pedido esta campaña.</label>
                <input class="display_none" type="radio" value="11" id="cb5" name="checkbox">
                <label for="cb5">Otros</label>
                <textarea name="txtOtrosCancelado" id="txtOtrosCancelado"></textarea>
            </div>
        </form>
        <div class="fuzemodal_buttons clear_co">
            <button id="btnCancelarPedido" class="boton_morado_2 margin_bottom_45" type="button" onclick="EjecutaCancelaSolicitud();">ENVIAR</button>
        </div>
    </div>
</div>
@section scripts{
    <script src="@Url.Content("~/Scripts/fuzemodal-1.3/fuzemodal-1.3.2.min.js")"></script>
    <script>
        function updateCantidadPedidos() {
            var cantPedidos = $('#PedidosPendientes').html();
            var resultCantPedidos = cantPedidos - 1;
            $('#PedidosPendientes').html(resultCantPedidos);
        }

        function CancelarSolicitud(PedidoId, DivPanelPedidoCancelado, panelTarget) {
            $("#CancelaPedidoId").val(PedidoId);
            $("#DivPanelPedidoCancelado").val(DivPanelPedidoCancelado);
            $("#DivPanelTarget").val(panelTarget);
            $("#modal_cancelar_pedido").fuzemodal('open');
        }

        function EjecutaCancelaSolicitud() {
            var opc = $('input[name=checkbox]:checked', '#frmCancelaPedido').val();
            var objHtmlPanelPedido = $("#DivPanelPedidoCancelado").val();
            var objHtmlPanelTarget = $("#DivPanelTarget").val();
            var params = {
                SolicitudId: $("#CancelaPedidoId").val(),
                OpcionCancelado: opc,
                RazonMotivoCancelado: $("#txtOtrosCancelado").val()
            };

            $.ajax({
                type: "POST",
                url: baseUrl + "ConsultoraOnline/CancelarPedido", //R2442 - JICM - se actualiza url
                contentType: 'application/json',
                data: JSON.stringify(params),
                success: function (data) {
                    if (checkTimeout(data)) {
                        if (data.success == true) {
                            var htmlRechazado = '<div class="text_gris_azul">CANCELADO</div><p class="font_size_11">' + data.message + '</p>';
                            $('#' + objHtmlPanelPedido).html(htmlRechazado);
                            var imgCancelado = '<img class="margin_right_10 vertical_align_top" src="/Content/Images/ConsultoraOnline/ic_cerrar.png" width="19" height="19" alt="" />';
                            $('#alertImage' + objHtmlPanelTarget).html(imgCancelado);
                            $('#telefonoDisplay' + objHtmlPanelTarget).css('display', 'none');
                            $('#datosDisplay' + objHtmlPanelTarget).css('display', 'none');
                            $('#MensajeConsultora' + objHtmlPanelTarget).html('');

                            $('#modal_cancelar_pedido').fuzemodal('close');
                        }
                        else {
                            console.log(data.message);
                        }
                    }
                },
                error: function (data, error) {
                    if (checkTimeout(data)) {
                        closeWaitingDialog();
                        alert("Ocurrió un error inesperado al momento de desafiliarte. Consulte con su administrador del sistema para obtener mayor información");
                    }
                }
            });

            $('#modal_cancelar_pedido').fuzemodal('close');
        }

        function RechazarSolicitud(PedidoId, NumIteracion, CodigoUbigeo, Campania, MarcaID, DivPanelPedidoRechazado) {
            $("#SolicitudId").val(PedidoId);
            $("#NumIteracion").val(NumIteracion);
            $("#CodigoUbigeo").val(CodigoUbigeo);
            $("#Campania").val(Campania);
            $("#MarcaID").val(MarcaID);
            $('#DivPanelPedidoRechazado').val(DivPanelPedidoRechazado);
            $("#modal_rechazar_pedido").fuzemodal('open');
        }

        function EjecutaRechazoPedido() {
            $(btnEnviarRechazo).prop('disabled', true);
            var opc = $('input[name=checkbox]:checked', '#frmRechazoPedido').val();
            var objHtmlPanelPedidoRechazado = $("#DivPanelPedidoRechazado").val();

            var params = {
                SolicitudId: $("#SolicitudId").val(),
                NumIteracion: $("#NumIteracion").val(),
                CodigoUbigeo: $("#CodigoUbigeo").val(),
                Campania: $("#Campania").val(),
                MarcaId: $("#MarcaID").val(),
                OpcionRechazo: opc,
                RazonMotivoRechazo: $("#txtOtrosRechazo").val()
            };
            $.ajax({
                type: "POST",
                url: baseUrl + "ConsultoraOnline/RechazarPedido",
                contentType: 'application/json',
                data: JSON.stringify(params),
                success: function (data) {
                    if (checkTimeout(data)) {

                        if (data.success == true) {
                            $('#modal_rechazar_pedido').fuzemodal('close');
                            var htmlRechazado = '<div class="text_gris_azul">RECHAZADO</div><p class="font_size_11">' + data.message + '</p>';
                            $('#DivPanel' + objHtmlPanelPedidoRechazado).html(htmlRechazado);
                            var imgRechazado = '<img class="margin_right_10 vertical_align_top" src="/Content/Images/ConsultoraOnline/ic_cerrar.png" width="19" height="19" alt="" />';
                            $('#alertImage' + objHtmlPanelPedidoRechazado).html(imgRechazado);
                            $('#telefonoDisplay' + objHtmlPanelPedidoRechazado).css('display', 'none');
                            $('#datosDisplay' + objHtmlPanelPedidoRechazado).css('display', 'none');
                            $('#MensajeConsultora' + objHtmlPanelPedidoRechazado).css('display', 'none');
                            updateCantidadPedidos();
                            $(btnEnviarRechazo).prop('disabled', false);
                        }
                        else {
                            alert_msg(data.message);
                        }
                    }
                },
                error: function (data, error) {
                    if (checkTimeout(data)) {
                        closeWaitingDialog();
                        alert_msg("Ocurrió un error inesperado al momento de desafiliarte. Consulte con su administrador del sistema para obtener mayor información");
                    }
                }
            });

            $('#modal_cancelar_pedido').fuzemodal('close');
        };

        $(document).ready(function () {

            //*************************************MODALS*******************************//
            $("#modal_aceptar_pedido").fuzemodal({ buttonIdOrClass: '.btnAcepta', speed: 450 });
            $("#modal_rechazar_pedido").fuzemodal({ buttonIdOrClass: '.btnRechaza', speed: 450 });
            $("#modal_cancelar_pedido").fuzemodal({ buttonIdOrClass: '.btnCancela', speed: 450 });

            $("#modal_desactivar_consultora").fuzemodal({ buttonIdOrClass: '#btnDesactivar', speed: 450 });

        });

        /**/
        function desa()
        {
            var opc = $('input[name=checkbox]:checked', '#frmDesafiliacion').val();
            var params = {
                ConsultoraID:@ViewBag.ConsultoraID,
                OpcionDesafiliacion: opc
            };
            $.ajax({
                type: "POST",
                url: baseUrl + "ConsultoraOnline/Desafiliar", 
                contentType: 'application/json',
                data: JSON.stringify(params),
                success: function (data) {
                    if (checkTimeout(data)) {

                        if (data.success == true) {
                            $('#modal_desactivar_consultora').fuzemodal('close');
                            location.href = baseUrl + "ConsultoraOnline/Informacion";
                        }
                        else {
                            alert_msg(data.message);
                        }
                    }
                },
                error: function (data, error) {
                    if (checkTimeout(data)) {
                        closeWaitingDialog();
                        alert_msg("Ocurrió un error inesperado al momento de desafiliarte. Consulte con su administrador del sistema para obtener mayor información");
                    }
                }
            });        
        }
        /**/

        /**Logica _ListaPedidos*/
        $('#PedidosPendientes').html('@ViewBag.CantidadPedidos');

        $(function () {
            $('#Pager').on('click', 'a', function () {
                $.ajax({
                    url: this.href,
                    type: 'GET',
                    cache: false,
                    success: function (result) {
                        $('#viewContentHolder').html(result);
                    },
                    error: function () {
                        $('#viewContentHolder').html('Ocurrio un error con la carga de la Pagina, contactese con su Administrador ...');
                    }
                });
                return false;
            });
        });

        $("#modal_aceptar_pedido").fuzemodal({ buttonIdOrClass: '.btnAcepta', speed: 450 });
        $("#modal_rechazar_pedido").fuzemodal({ buttonIdOrClass: '.btnRechaza', speed: 450 });
        $("#modal_cancelar_pedido").fuzemodal({ buttonIdOrClass: '.btnCancela', speed: 450 });


        $(".btnAceptar").click(function () {
            waitingDialog({});
            var cell = $(this);
            cell.prop('disabled', true);
            var pedidoId = $(this).data('id');
            var panelTarget = 'alertImage' + $(this).data('imgpane');
            var panelTargetNumber = $(this).data('imgpane');

            $("#viewPlaceHolder").load("/ConsultoraOnline/AceptarPedido",
            { id: "" + pedidoId + "" }, function (reponse, status, xhr) {
                if (status == "success") {
                    closeWaitingDialog();
                    $("#modal_aceptar_pedido").fuzemodal('open');
                    updateCantidadPedidos();
                    var htmlCancelContent = '<div class="text_verde2 margin_bottom_45">ACEPTADO</div>' +
                            '<button type="button" class="boton_linea_verde margin_left_23 btnCancelar" onclick=";CancelarSolicitud(' + pedidoId + ',\'' + cell.parent().closest("div").attr("id") + '\',\'' + panelTargetNumber + '\');" >CANCELAR</button> ' +
                            '<div class="wrap_pregunta">' +
                                '<img class="ic_pregunta" src="/Content/Images/ConsultoraOnline/ic_pregunta.png" width="19" height="19" alt="" />' +
                                '<img class="cont_info" src="/Content/Images/ConsultoraOnline/cont_pregunta.png" width="140" height="48" alt="" />' +
                            '</div>';
                    var imgAceptado = '<img class="margin_right_10 vertical_align_top" src="/Content/Images/ConsultoraOnline/ic_aceptar.png" width="19" height="19" alt="" />';
                    $('#' + panelTarget).html(imgAceptado);
                    cell.parent().html(htmlCancelContent);

                } else {
                    console.log('Error al invocar /ConsultoraOnline/AceptarPedido');
                }
            });

        });

        //EPD-713 - Inicio
        $(".btn_correo_direc").click(function () {

            $('.cont_correo_direc').addClass('ocultarHide');
            $(this).find(".cont_correo_direc").removeClass('ocultarHide');
            $(this).find(".cont_correo_direc").addClass('mostrarShow');
            $(this).find(".cont_correo_direc").addClass('on');

        });

        $(document).click(function (e) {

            var el = e.target || event.srcElement
            if (el.id != 'btninfo' && el.id != 'info') {
                $('.cont_correo_direc').removeClass('mostrarShow');
                $('.cont_correo_direc').addClass('ocultarHide');
            }
        });

        //EPD-713 - Inicio

        $(".ic_pregunta").click(function () {
            $(this).parent().find(".cont_info").animate({
                display: "block",
                opacity: 1,
                height: "toggle"
            }, 100, function () {
                // Animation complete.
            });
        });

    </script>
}