@{
    ViewBag.Title = "_ListadoOfertasFlexipago";
}

<script type="text/javascript">
    function InfoCommerceGoogle(ItemTotal, CUV, DescripcionProd, Categoria, Precio, Cantidad, Marca) {
        if (ItemTotal >= 0 && Precio >= 0 && Cantidad > 0) {
            dataLayer.push({
                'event': 'ecommerce',
                'transactionId': '@ViewBag.CodigoISODL' + '+' + '@ViewBag.CodigoConsultoraDL' + '+' + Math.floor(Math.random() * 1000000000),
				'transactionAffiliation': Categoria,
				'transactionTotal': ItemTotal,
				'transactionTax': '0',
				'transactionShipping': '0',
				'transactionProducts': [
					{
					    'sku': CUV,
					    'name': DescripcionProd,
					    'category': Marca,
					    'price': Precio,
					    'quantity': Cantidad
					}
				]
			});
        }
    }

    ///////////////////////////

    function ReservadoOEnHorarioRestringido(mostrarAlerta) {

        mostrarAlerta = typeof mostrarAlerta !== 'undefined' ? mostrarAlerta : true;
        var restringido = true;

        $.ajaxSetup({ cache: false });
        jQuery.ajax({
            type: 'GET',
            url: '@Url.Action("ReservadoOEnHorarioRestringido", "Pedido")',
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            async: false,
            success: function (data) {
                if (checkTimeout(data)) {
                    if (data.success == false) restringido = false;
                    else {
                        if (data.pedidoReservado) {
                            var fnRedireccionar = function () {
                                waitingDialog({});
                                location.href = '@Url.Action("PedidoValidado", "Pedido")'
                            }
                            if (mostrarAlerta == true) alert_msg(data.message, fnRedireccionar);
                            else fnRedireccionar();
                        }
                        else if (mostrarAlerta == true)
                            alert_msg(data.message);
                            //setTimeout(function () { location.href = '@Url.Action("Index", "Bienvenida")'; }, 2500);
                    }
                }
            },
            error: function (error) {
                alert_msg('Ocurrió un error al intentar validar el horario restringido o si el pedido está reservado. Por favor inténtelo en unos minutos.');
            }
        });
        return restringido;
    }


    //////////////////////////

    function AgregarOfertaProducto(Object) {

        if (ReservadoOEnHorarioRestringido())
            return;

        var Cantidad = $(Object).parent().parent().find(".ValidaNumeralOferta")[0].value;
        var OfertaProductoID = $(Object).prev('input[type="hidden"]').val();
        var div = $(Object).parent().parent().parent().parent().find(".producto_agregado");
        var TipoOfertaID = $(Object).parent().parent().parent().parent().find(".TipoOfertaSisID")[0].value;
        var ConfiguracionOfertaID = $(Object).parent().parent().parent().parent().find(".ConfiguracionOfertaID")[0].value;
        var MarcaID = $(Object).parent().parent().parent().parent().find(".MarcaID")[0].value;
        var CUV = $(Object).parent().parent().parent().parent().find(".CUV")[0].value;
        var PrecioUnidad = $(Object).parent().parent().parent().parent().find(".PrecioOferta")[0].value;
        var DescripcionProd = $(Object).parent().parent().parent().parent().find(".DescripcionProd")[0].value;
        var DescripcionMarca = $(Object).parent().parent().parent().parent().find(".DescripcionMarca")[0].value;

        if (Cantidad == "" || Cantidad == 0) {
            alert_msg("La cantidad ingresada debe ser mayor que 0, verifique.");
            return false;
        }

        else {
            $($(Object).parent().parent().find(".ValidaNumeralOfertaAnterior")).val(Cantidad);
            var Item = {
                MarcaID: MarcaID,
                Cantidad: Cantidad,
                PrecioUnidad: PrecioUnidad,
                CUV: CUV,
                ConfiguracionOfertaID: ConfiguracionOfertaID
            };
            waitingDialog({});
            $.ajaxSetup({
                cache: false
            });

            jQuery.ajax({
                type: 'POST',
                url: baseUrl + 'OfertaFlexipago/InsertOfertaWebPortal',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(Item),
                async: true,
                success: function (data) {
                    if (data.success == true) {
                        $(Object).attr('disabled', true);
                        $(div).css('display', 'block');
                        CalcularAcumuladoCarrito();
                        $("#hdFlagOferta").val("1");
                        InfoCommerceGoogle(parseFloat(Cantidad * PrecioUnidad).toFixed(2), DescripcionProd, CUV, 'ofertas­‐flexipago', PrecioUnidad, Cantidad, DescripcionMarca);
                    }
                    else {
                        alert_msg(data.message);
                    }
                    closeWaitingDialog();
                },
                error: function (data, error) {
                    if (checkTimeout(data)) {
                        alert_msg(data.message);
                        closeWaitingDialog();
                    }
                }
            });

        }
    }

    function ActualizarCantidadProducto(Object) {

        var estadoBoton = $(Object).parent().find(".btnAdd")[0].disabled;

        if (estadoBoton) {
            waitingDialog({});
            var cantidadActual = $(Object).val();
            //Validación de Ingreso Vacío
            if (cantidadActual == "" || cantidadActual == "0") {
                var cantidadAnterior = $(Object).prev('input[type="hidden"]').val();
                $(Object).val(cantidadAnterior);
                closeWaitingDialog();
                return false;
            } else {
                var Cantidad = $(Object).val();
                var CantidadAnterior = $(Object).prev('input[type="hidden"]').val();
                var TipoOfertaID = $(Object).parent().parent().parent().find(".TipoOfertaSisID")[0].value;
                var ConfiguracionOfertaID = $(Object).parent().parent().parent().find(".ConfiguracionOfertaID")[0].value;
                var MarcaID = $(Object).parent().parent().parent().find(".MarcaID")[0].value;
                var CUV = $(Object).parent().parent().parent().find(".CUV")[0].value;
                var PrecioUnidad = $(Object).parent().parent().parent().find(".PrecioOferta")[0].value;
                var DescripcionProd = $(Object).parent().parent().parent().parent().find(".DescripcionProd")[0].value;
                var DescripcionMarca = $(Object).parent().parent().parent().parent().find(".DescripcionMarca")[0].value;

                $.ajaxSetup({
                    cache: false
                });
                if (Cantidad == CantidadAnterior) {
                    closeWaitingDialog();
                    return false;
                }
                else {
                    $(Object).prev('input[type="hidden"]').val(Cantidad);

                    var Item = {
                        MarcaID: MarcaID,
                        Cantidad: Cantidad,
                        CantidadAnterior: CantidadAnterior,
                        PrecioUnidad: PrecioUnidad,
                        CUV: CUV,
                        ConfiguracionOfertaID: ConfiguracionOfertaID
                    };

                    jQuery.ajax({
                        type: 'POST',
                        url: baseUrl + 'OfertaFlexipago/UpdateOfertaWebPortal',
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(Item),
                        async: true,
                        success: function (data) {
                            if (data.success == true) {
                                CalcularAcumuladoCarrito();
                                InfoCommerceGoogle(parseFloat(Cantidad * PrecioUnidad).toFixed(2), DescripcionProd, CUV, 'ofertas­‐flexipago', PrecioUnidad, Cantidad, DescripcionMarca);
                            }
                            else {
                                alert_msg(data.message);
                            }
                            closeWaitingDialog();
                        },
                        error: function (data, error) {
                            if (checkTimeout(data)) {
                                alert_msg(data.message);
                                closeWaitingDialog();
                            }
                        }
                    });
                }

            }
        }
    }

    function CalcularAcumuladoCarrito() {
        var cantidad = 0;
        var items = $(".ValidaNumeralOferta");
        for (var i = 0; i < items.length; i++) {
            var estado = $(items[i]).parent().find(".btnAdd")[0].disabled;
            if (parseInt(items[i].value) > 0 && estado)
                cantidad += parseInt(items[i].value)
        }
        $("#spCantidadItems").text(cantidad);
    }

</script>

<input type="hidden" id="hdFlagOferta" value="0" />
@{
    List<Portal.Consultoras.Web.Models.OfertaFlexipagoModel> lstOfertas = ViewBag.ListaOfertasFlexipago;
    string ISO = ViewBag.ISO;
    string Simbolo = ViewBag.Simbolo;
}
@if (lstOfertas != null)
{
    foreach (var item in lstOfertas)
    {
        if (item.ConfiguracionOfertaID == Portal.Consultoras.Common.Constantes.TipoOferta.Flexipago)
        {
    <div class="modulo_ofertas">
        <input type="hidden" class="TipoOfertaSisID" value="@item.TipoOfertaSisID"/>
        <input type="hidden" class="ConfiguracionOfertaID" value="@item.ConfiguracionOfertaID"/>
        <input type="hidden" class="MarcaID" value="@item.MarcaID"/>
        <input type="hidden" class="CUV" value="@item.CUV"/>
        <input type="hidden" class="PrecioOferta" value="@item.PrecioOferta"/>
        <input type="hidden" class="Stock" value="@item.Stock"/>
        <input type="hidden" class="DescripcionProd" value="@item.Descripcion"/>
        <input type="hidden" class="DescripcionMarca" value="@item.DescripcionMarca"/>

        <div class="ofertas_producto">
            <div class="ofertas_producto_left">
                <div class="producto_agregado_flexipago">
                            <img src='@Url.Content("~/Content/Images/flexipago_prd.png")'>
                        </div>
                <div class="producto_agregado" style="display: none;">
                    <div>Agregado</div>
                </div>
                @if (!item.ImagenProducto.Equals(string.Empty))
                {
                    <img src='@item.ImagenProducto' alt="Imagen Producto">
                }
                else
                {
                    <img src='@Url.Content("~/Content/Matriz/Producto_Sin_Imagen.png")' alt="Imagen Producto">
                }
            </div>
        </div>
        <div class="ofertas_foot">
            <div class="ofertas_detail">
                <span class="texto">@item.Descripcion
                </span>
            </div>
            <div class="ofertas_precio_normal">Precio Normal : <span class="num">@Simbolo @string.Format("{0:#,##0.00}", item.PrecioNormal)</span></div>
            <div style="display:none" class="ofertas_precio_normal">Stock : <span class="spStock">@item.Stock</span></div>
        </div>
        <div class="ofertas_foot">
            <div class="ofertas_precio">
                Precio <b>Oferta</b>: 
                            <div>
                                <span class="superindice">@Simbolo</span><span class="num">@string.Format("{0:#,##0.00}", item.PrecioOferta)</span>
                            </div>
            </div>
            <div class="ofertas_cantidad">
                <span>Cantidad</span>
                <input type="hidden" class="ValidaNumeralOfertaAnterior" />
                <input type="text" maxlength="2" class="ValidaNumeralOferta" onblur="ActualizarCantidadProducto(this)">
                <div class="ofertas_agregar_pedido">
                    <input type="hidden" value="@item.OfertaProductoID" class="OfertaProductoID" />
                    <input type="button" value="Agregar" class="btnAdd" onclick='AgregarOfertaProducto(this)'>
                </div>
            </div>
        </div>
    </div>
        }
    }
}