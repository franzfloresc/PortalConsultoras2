@model Portal.Consultoras.Web.Models.ReporteConsultoraPedidoSACModels
@{
    ViewBag.Title = "Index";
}

<style>
    .disabled {
        background: none repeat scroll 0 0 burlyWood;
        cursor: default !important;
    }
</style>

<script type="text/javascript">
    var NRO_LOTE = 0;
    var rutaImagenArchivoClientes = '@Url.Content("~/Content/Images/update.png")';
    var rutaImagenCalendar = '@Url.Content("~/Content/Images/calendar.png")';

    $(document).ready(function(){
        fnGrilla();
        $("#btnDescargar").data('click', false);
        $("#btnDescargar").click(function () {
            RealizarDescarga($(this));
        });

        $("#ddlPais").attr("disabled", true);
    });


    function RealizarDescarga($btnClick) {
        var vMessage = "";

        if ($("#ddlPais").val() == "") {
            vMessage += "Debe seleccionar un País";
        }

        if ($("#ddlCampania").val() == "") {
            vMessage += "Debe seleccionar una Campaña";
        }

        if (vMessage != "") {
            alert(vMessage);
            return false;
        }
        else {
            // Click anterior
            // Si ya se clickeo anteriormente y aun no termina proceso.
            if ($btnClick.data('click')) {
                alert("Esperando finalización de proceso anterior.");
                return;
            }

            // Si no hay clicks anteriores pendientes
            // Seguimos en este click
            $btnClick.data('click', true);

            var waiting = {
                message: 'Espere unos minutos, por favor...',
                title: 'Ejecutando Proceso'
            }
            waitingDialog(waiting);

            var JsonData = {
                PaisID: $("#ddlPais").val(),
                CampanaId: $("#ddlCampania").val(),
                NroLote: NRO_LOTE
            };

                $.ajax({
                    type: 'POST',
                    url: baseUrl + 'ReporteConsultoraPedidoSAC/RealizarDescargaSinMarcar',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(JsonData),
                    async: true,
                    success: function (data) {
                        if (!checkTimeout(data)) return;
                        
                        closeWaitingDialog();
                        alert(data.message);
                        if (!data.success) return;

                        $("#list").GridUnload();
                        fnGrilla();
                        if (data.cabecera && data.IsFox) {
                            $("#hdnfileHeader").val(data.rutac);
                            $("#hdnfileDetail").val(data.rutad);
                            $("#hdnfileDetailAct").val(data.rutae);
                        }
                    }
                    , complete: function () {
                        $('#btnDescargar').removeClass('disabled');
                        $btnClick.data('click', false); // Termino el click
                    }
                    , error: function (data, error) {
                        if (checkTimeout(data)) {
                            closeWaitingDialog();
                            alert("Error del Sistema.");
                        }
                    }
                });
        }
    }

    function ShowActionsArchivoClientes(cellvalue, options, rowObject) {

        var Des = "";
        if (rowObject.NroLote == 0) {
            Des = "<img disabled  src='" + rutaImagenArchivoClientes + "' alt='Generar Archivo Clientes' title='Generar Archivo Clientes' border='0' style='cursor:pointer' />";
        } else { 
            Des = "<img   src='" + rutaImagenArchivoClientes + "' alt='Generar Archivo Clientes' title='Generar Archivo Clientes' border='0' style='cursor:pointer' />";
            NRO_LOTE = rowObject.NroLote;
        }
        return Des;
    }

    function fnGrilla() {
        
        jQuery("#list").jqGrid({
            url: baseUrl + "ReporteConsultoraPedidoSAC/ObtenerUltimaDescargaPedidoSinMarcar",
            hidegrid: false,
            datatype: 'json',
            mtype: 'GET',
            contentType: "application/json; charset=utf-8",
            colNames: ['Fecha/Hora Inicio', 'Fecha/Hora Fin', 'Estado', 'Mensaje', 'Número de pedidos','Archivo Clientes', 'NroLote'],
            colModel: [
                { name: 'FechaHoraInicio', index: 'FechaHoraInicio', width: 22, editable: false, resizable: false, align: "center" },
                { name: 'FechaHoraFin', index: 'FechaHoraFin', width: 22, editable: false, resizable: false, align: "center" },
                { name: 'Estado', index: 'Estado', width: 15, editable: false, resizable: true, align: "center" },
                { name: 'Mensaje', index: 'Mensaje', width: 30, editable: false, resizable: true },
                { name: 'NumeroPedidos', index: 'NumeroPedidos', width: 20, editable: true, resizable: false },
                { name: 'ArchivoClientes', index: 'ArchivoClientes', width: 22, editable: false, resizable: false, hidden: false, align: "center", formatter: ShowActionsArchivoClientes },
                { name: 'NroLote', index: 'NroLote', hidden: true, },
            ],
            jsonReader:
                {
                    root: "rows",
                    page: "page",
                    total: "total",
                    records: "records",
                    repeatitems: false,
                    id: "NroLote"
                },
            loadtext: 'Cargando datos...',
            emptyrecords: 'No hay resultados',
            height: 'auto',
            width: 930,
            altRows: true,
            altclass: 'jQGridAltRowClass',
            loadComplete: function () {
            },
            //gridComplete: function () {
            //    obtenerUltimaDescargaExitosa();
            //},
            cache: false,
            cmTemplate: { sortable: false },
            onCellSelect: function (rowId, iCol, content, event) {
                if (iCol == 8) ArchivoClientes(rowId);
            }
        });
    }



    function obtenerUltimaDescargaExitosa() {
        
        waitingDialog({});
        $.ajax({
            type: 'POST',
            url: baseUrl + 'ReporteConsultoraPedidoSAC/ObtenerUltimaDescargaExitosaSinMarcar',
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            async: true,
            cache: false,
            success: function (data) {
                if (checkTimeout(data)) {
                    closeWaitingDialog();
                    if (data.success == true) {
                    }
                }
            },
            error: function (data, error) {
                if (checkTimeout(data)) {
                    alert("Error del Sistema.");
                }
            }
        });
    }


    function ArchivoClientes(rowId) {
        
        var waiting = {
            message: 'Espere unos minutos, por favor...',
            title: 'Ejecutando Proceso'
        }
        waitingDialog(waiting);

        $.ajax({
            type: 'POST',
            url: baseUrl + 'ReporteConsultoraPedidoSAC/DescargarArchivoClienteSinMarcar',
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            data: "{nroLote: " + rowId + ", campaniaid: " + $("#ddlCampania").val()  + "}",
            async: true,
            success: function (data) {
                if (checkTimeout(data)) {
                    closeWaitingDialog();
                    alert(data.mensaje);
                }
            },
            error: function (data, error) {
                if (checkTimeout(data)) {
                    closeWaitingDialog();
                    alert("Error del Sistema.");
                }
            }
        });
    }
</script>


<div class="wrap_cab">
    <div class="filtros">
        <div class="elements">
            <div class="div-2">
                <h1>Carga de Pedidos Campaña</h1>
            </div>
        </div>
    </div>
</div>
<div class="wrap">
    <div class="container clearfix">
        <div class="border-wrapper_reg">
            <div class="DescargaParams">
                <div class="celda">
                    <span>País:</span>
                    <div class="selectP2 borde_redondeado">
                        @Html.DropDownListFor(model => model.PaisID, new SelectList(Model.listaPaises, "PaisID", "Nombre"), new { id = "ddlPais" })
                    </div>
                </div>
                <div class="celda">
                    <span>Campaña:</span>
                    <div class="selectP2 borde_redondeado">
                        @Html.DropDownListFor(model => model.PaisID, new SelectList(Model.listaCampania, "CampaniaID", "Codigo"), new { id = "ddlCampania" })
                    </div>
                </div>
            
                <div class="celda">
                    <span></span>
                    <div class="input_add_alert_left">
                        <input type="button" name="" id="btnDescargar" value="Descargar" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="hdnfileHeader" name="hdnfileHeader" />
    <input type="hidden" id="hdnfileDetail" name="hdnfileDetail" />
    <input type="hidden" id="hdnfileDetailAct" name="hdnfileDetailAct" />
</div>
<div class="wrap">
    <div class="container clearfix">
        <div class="border-wrapper">
            <table id="list"></table>
            <div id="pager"></div>
        </div>
    </div>
</div>
<div id="loadingScreen"></div>

