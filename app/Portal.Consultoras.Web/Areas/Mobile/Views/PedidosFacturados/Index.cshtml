@using Portal.Consultoras.Web.Helpers
@model Portal.Consultoras.Web.Areas.Mobile.Models.PedidoWebClientePrincipalMobilModel
@{
    Layout = "~/Areas/Mobile/Views/Shared/_MobileLayout.cshtml";
}
<div class="titulo_mobile">
    @{  var mobileConfiguracion = Html.MobileAppConfiguracion();
        if (mobileConfiguracion.MostrarBotonAtras)
        {
            <a href="@Request.UrlReferrer" class="enlace_regresar catalogosR" title="Regresar"></a>
        } }
    PEDIDO FACTURADO
</div>

@if (Model.ListaPedidoCliente.Count == 0)
{
    <div class="">
        <div class="pestana_esika"></div>
        <div class="pestana_lbel"></div>
        <div class="col-xs-12">
            <div class="icono_alerta exclamacion_icono_mobile"></div>
            <div class="mensaje_alerta">Hasta el momento no tienes ningún pedido facturado.</div>
        </div>
    </div>
}
else
{
    <div class="fondo_f2f2f2">
        <div class="pestana_esika"></div>
        <div class="pestana_lbel"></div>
        <div class="tabs-link tab-primary upper">
            @for (int i = 0; i < Model.ListaPedidoCliente.Count; i++)
            {
                var pedidoCliente = Model.ListaPedidoCliente[i];

                <a href="javascript:;" class="mytab @( i == 0 ? "active" : "")" data-campania="@pedidoCliente.CampaniaID" data-idpedido="@pedidoCliente.PedidoId" style="width: @(100.00 / Model.ListaPedidoCliente.Count)%">
                    <small>Campaña</small>
                    <br />
                    <b>@pedidoCliente.CampaniaID.ToString().Substring(4)</b>
                    @pedidoCliente.CampaniaID.ToString().Substring(0, 4)
                </a>
            }
        </div>
        @for (int i = 0; i < Model.ListaPedidoCliente.Count; i++)
        {
            <div class="col-xs-12">
                <div id="divListaPedidoDetalle_@(Model.ListaPedidoCliente[i].CampaniaID)_@(Model.ListaPedidoCliente[i].PedidoId)" style="@( i > 0 ? "display:none;" : "" )">
                </div>
            </div>
        }
    </div>
}
@section scripts{
    <script type="text/javascript">
        var primerEnvio = 0;
        var pedidoActual = "";
        var pedidosCargados = new Array();

        $(document).ready(function () {
            $(".mytab").click(function () {
                $('.mytab.active').removeClass("active");
                $(this).addClass("active");

                var campaniaSeleccionada = $(this).attr("data-campania");
                var pedidoIdSeleccionado = $(this).attr("data-idpedido");
                pedidoSeleccionado = campaniaSeleccionada + '_' + pedidoIdSeleccionado;

                if (pedidoActual != pedidoSeleccionado) {
                    $('#divListaPedidoDetalle_' + pedidoActual).hide();
                    $('#divListaPedidoDetalle_' + pedidoSeleccionado).show();

                    if (pedidosCargados.indexOf(pedidoSeleccionado) > -1) {
                        pedidoActual = pedidoSeleccionado;
                        dataLayer.push({ 'event': 'virtualPage', 'pageUrl': '@Url.Action("", "PedidosFacturados", new {area = "Mobile"})' + '/' + campaniaSeleccionada, 'pageName': 'Pedidos Facturados - ' + campaniaSeleccionada });
                    }
                    else cargarDetallePedido(campaniaSeleccionada, pedidoIdSeleccionado);
                }
            });
            $('.mytab.active').trigger("click");
        });

        function cargarDetallePedido(campaniaID, pedidoId) {

            if (!campaniaID) return;
            if (!pedidoId) return;

            ShowLoading();
            jQuery.ajax({
                type: 'POST',
                url: '@Url.Action("Detalle", "PedidosFacturados", new {area = "Mobile"})',
                dataType: 'html',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ campaniaID: campaniaID, pedidoId: pedidoId }),
                async: true,
                success: function (html) {
                    pedidoActual = campaniaID + '_' + pedidoId;
                    $("#divListaPedidoDetalle_" + pedidoActual).html(html);
                    if (primerEnvio != 0) {
                        dataLayer.push({ 'event': 'virtualPage', 'pageUrl': '@Url.Action("", "PedidosFacturados", new {area = "Mobile"})' + '/' + campaniaID, 'pageName': 'Pedidos Facturados - ' + campaniaID });
                    }
                    primerEnvio++;

                    pedidosCargados.push(pedidoActual);
                    CloseLoading();
                },
                error: function (data, error) {
                    if (checkTimeout(data)) {
                        CloseLoading();
                        console.log(data, error);
                    }
                }
            });
        }
    </script>
}
