@using System.Globalization
@using Portal.Consultoras.Web.Helpers
@using Portal.Consultoras.Web.ServiceUsuario
@using Portal.Consultoras.Common

@model BEMisPedidos

@{
    var nombreMes = Util.NombreMes(Model.FechaSolicitud.AddDays(1).Month);
    var nombreMes2 = Util.NombreMes(Model.FechaModificacion.HasValue ? Model.FechaModificacion.Value.Month : 1);
}

@{
    Layout = "~/Areas/Mobile/Views/Shared/_MobileLayout.cshtml";
}

@section styles{
    <style type="text/css">
        body {
            background: #FFF !important;
        }
    </style>
}

<div class="titulo_mobile" style="font-size:13px;">
    @{  var mobileConfiguracion = Html.MobileAppConfiguracion();
        if (mobileConfiguracion.MostrarBotonAtras)
        {
            <a href="@Request.UrlReferrer" class="enlace_regresar catalogosR" title="Regresar"></a>
        } }
    APP DE CATÁLOGOS: MIS PEDIDOS
</div>
<div class="pestana_esika"></div>
<div class="pestana_lbel"></div>

@Html.HiddenFor(p => p.PedidoId)
@Html.HiddenFor(p => p.NumIteracion)
@Html.HiddenFor(p => p.CodigoUbigeo)
@Html.HiddenFor(p => p.Campania)
@Html.HiddenFor(p => p.MarcaID)



<div class="col-xs-12">
    <ul class="list-notificaciones noti-detalle noti-pedido">
        <li>

            <div class="text-noti">
                <div class="sub_titulo_noti">
                    <span>PEDIDO DE @Model.Cliente</span>
                    <span>CAMPAÑA @Model.Campania.Substring(4, 2) @Model.Campania.Substring(0, 4)</span>
                </div>
                <span>@Model.FechaSolicitud.ToString("dd/MM/yyyy") @String.Format("{0:hh:mm tt}", Model.FechaSolicitud)</span>
            </div>
        </li>
    </ul>
</div>



<div class="detalle-pedido fz-14">
    <div class="col-xs-12">
        <br />
        @if (string.IsNullOrEmpty(Model.Estado))
            {
            <p class="mb-30">Tienes hasta el <strong>@Model.FechaSolicitud.AddDays(1).ToString("dddd", new CultureInfo("es-ES")) @Model.FechaSolicitud.AddDays(1).Day de @nombreMes a las @Model.FechaSolicitud.AddDays(1).ToString("HH:mm") horas</strong> para contactarte con tu nuevo cliente y ACEPTAR o RECHAZAR el pedido haciendo click al final de este mensaje.</p>
        }
        else
        {
            var tieneFecha = Model.FechaModificacion.HasValue;
            var cumpleCondicion = tieneFecha && Model.FechaModificacion.Value.AddDays(1) >= DateTime.Now;
            var texto = cumpleCondicion ? "" : tieneFecha ? (", el día " + Model.FechaModificacion.Value.ToString("dddd", new CultureInfo("es-ES")) + " " + Model.FechaModificacion.Value.Day + " de " + nombreMes2 + " a las " + Model.FechaModificacion.Value.ToString("HH:mm") + " horas") : "";

            if (Model.Estado.Trim().Equals("A"))
            {
                <p class="mb-30">ACEPTADO <strong>@texto</strong></p>
            }
            else
            {
                if (Model.Estado.Trim().Equals("R"))
                {
                    <p class="mb-30">RECHAZADO <strong>@texto</strong></p>
                }
                else
                {
                    if (Model.Estado.Trim().Equals("C"))
                    {
                        <p class="mb-30">CANCELADO <strong>@texto</strong></p>
                    }
                }
            }
        }

        <h3 class="title-line bold"> INFORMACIÓN DEL CLIENTE </h3>

        <ul class="list-info-cliente">
            <li><span>Nombre del cliente:</span> <strong>@Model.Cliente</strong></li>
            <li><span>Correo:</span> <strong>@Model.Email</strong></li>
            <li><span>Telefono:</span> <strong>@Model.Telefono</strong></li>
            <li><span>Dirección:</span> <strong>@Model.Direccion</strong></li>
            <li><span>Comentario:</span> <strong>@Model.MensajeDelCliente</strong></li>
        </ul>

        <h3 class="title-line bold"> Detalle del pedido</h3>
        <p class="consultora_saludo_noti">Productos que el cliente desea comprar y el precio máximo que espera pagar. Contáctalo y cuéntale el precio del catálogo de la campaña vigente.</p>

        @foreach (var item in Model.DetallePedido)
        {
            var textoTono = @item.Tono == "" ? "" : "Tono: " + item.Tono + "<br/>";
            <div class="detalle_notificaciones">
                <div class="left_reservado" style="width:235px;">
                    <div class="datos_Reservado">
                        <span> @item.Marca </span>
                        <span>@item.Producto</span>
                        <span>@Html.Raw(textoTono)  </span>
                    </div>
                </div>
                <div class="right_reservado">
                    <div class="texto_reservado">CANT</div>
                    <div class="datos_Reservado"><b>@item.Cantidad</b></div>
                </div>
                <hr class="clear"><br>
                <div class="left_reservado">
                    <div class="texto_reservado">
                        <span>Precio sin descuento</span>
                    </div>

                    <div class="importe_reservado">SUBTOTAL</div>
                </div>
                <div class="right_reservado">
                    <div class="texto_reservado">
                        <span>@ViewBag.Simbolo @item.PrecioUnitario.ToString("N2")</span>
                    </div>

                    <div class="importe_reservado">@ViewBag.Simbolo @item.PrecioTotal.ToString("N2")</div>
                </div>
            </div>
        }
        <hr class="clear" />
        <div class="left_reservado">
            <div class="importe_final">
                <b>MONTO TOTAL</b>
            </div>
        </div>
        <div class="right_reservado">
            <div class="importe_final" style="font-size:15px"><b> @ViewBag.Simbolo @Model.DetallePedido.Sum(p => p.PrecioTotal).ToString("N2")</b></div>
        </div>

        @if (string.IsNullOrEmpty(Model.Estado))
            {
            <p class="text-center text-centersb2">
                <a href="javascript:;" id="btnAceptarPedido" class="btn btn-action-hover btn-round btn-align">Aceptar</a><br>
                <a href="javascript:;" id="btnRechazarPedido" class="btn btn-line-action btn-round mt-20 btn-align">Rechazar</a>
            </p>
                <p class="mt-30">
                    Este es el mensaje que le llegará al cliente una vez aceptado el pedido:
                </p>

                <div class="form-controls-grey">
                    <textarea name="" id="txtMensajeConsultora" class="form-control" rows="3" disabled="disabled">@string.Format("Gracias por haber escogido a {0} como tu Consultora. Pronto se pondrá en contacto contigo para coordinar la hora y lugar de entrega.", ViewBag.NombreCompleto)</textarea>
                </div>
        }
        else
        {
            if (Model.Estado.Trim().Equals("A"))
            {
                var condicionAceptado = Model.FechaModificacion.HasValue && Model.FechaModificacion.Value.AddDays(1) >= DateTime.Now;
                if (condicionAceptado)
                {
                    <p class="text-center">
                        <a href="javascript:;" id="btnCancelarPedido" class="btn btn-action-hover btn-round btn-align">Cancelar</a><br>
                    </p>
                }
            }
        }
        <hr class="clear" />
        <p class="firma_notificaciones">

            Gracias,
            <br>
            Equipo de Belcorp.

        </p>
        <br>
    </div>

</div>


<div id="popupRechazar" class="modal fade" data-backdrop="static" data-keyboard="false" style="z-index: 10000 !important; ">
    <div class="modal-dialog modal-alert ">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row text-left">
                    <div class="col-xs-12">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="icon-close-belcorp"></i></button>
                        <h3 class="title-landing text-center bold">¿NOS PUEDES CONTAR LA RAZON POR LA QUE NO ACEPTAS EL PEDIDO?</h3>
                    </div>
                </div>

                <div class="row text-left">
                    <div class="form-controls-grey">
                        <div class="col-xs-12">
                            <div class="form-group">
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>Los clientes no desean esperar tanto tiempo para el pedido.</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion1" class="checkbox__input" name="optionsRadios" value="1">
                                        <label for="rbtOpcion1" class="checkbox__label"></label>
                                    </div>
                                </div>
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>No me llegan pedidos.</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion2" class="checkbox__input" name="optionsRadios" value="2">
                                        <label for="rbtOpcion2" class="checkbox__label"></label>
                                    </div>
                                </div>
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>No me genera ingresos.</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion3" class="checkbox__input" name="optionsRadios" value="3">
                                        <label for="rbtOpcion3" class="checkbox__label"></label>
                                    </div>
                                </div>
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>Por diferencia en precios de web y campaña.</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion4" class="checkbox__input" name="optionsRadios" value="4">
                                        <label for="rbtOpcion4" class="checkbox__label"></label>
                                    </div>
                                </div>
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>Volveré. Sólo me estoy tomando un descanso.</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion5" class="checkbox__input" name="optionsRadios" value="5">
                                        <label for="rbtOpcion5" class="checkbox__label"></label>
                                    </div>
                                </div>
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>Otros</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion6" class="checkbox__input" name="optionsRadios" value="6">
                                        <label for="rbtOpcion6" class="checkbox__label"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <textarea id="txtOtrosRechazo" class="form-control"></textarea>
                            </div>
                            <div class="block-center text-center">
                                <a id="btnEnviarRechazoPedido" class="btn btn-action-hover btn-round">Enviar</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="popupCancelar" class="modal fade" data-backdrop="static" data-keyboard="false" style="z-index: 10000 !important; ">
    <div class="modal-dialog modal-alert ">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row text-left">
                    <div class="col-xs-12">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="icon-close-belcorp"></i></button>
                        <h3 class="title-landing text-center bold">CANCELA EL PEDIDO</h3>
                    </div>
                </div>

                <div class="row text-left">
                    <div class="form-controls-grey">
                        <div class="col-xs-12">
                            <div class="form-group">
                                Cuéntanos por qué tuviste que cancelar el pedido
                            </div>
                            <div class="form-group">
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>Yo no puedo atender su pedido.</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion7" class="checkbox__input" name="optionsRadios" value="7">
                                        <label for="rbtOpcion7" class="checkbox__label"></label>
                                    </div>
                                </div>
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>El cliente vive muy lejos.</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion8" class="checkbox__input" name="optionsRadios" value="8">
                                        <label for="rbtOpcion8" class="checkbox__label"></label>
                                    </div>
                                </div>
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>El/los productos están agotados en esta campaña.</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion9" class="checkbox__input" name="optionsRadios" value="9">
                                        <label for="rbtOpcion9" class="checkbox__label"></label>
                                    </div>
                                </div>
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>No pasaré pedido esta campaña.</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion10" class="checkbox__input" name="optionsRadios" value="10">
                                        <label for="rbtOpcion10" class="checkbox__label"></label>
                                    </div>
                                </div>
                                <div class="check-label" style="text-align: left; padding-left: 30px;">
                                    <span>Otros</span>
                                    <div class="checkbox checkbox--standalone" style="left:-15px;">
                                        <input type="radio" id="rbtOpcion11" class="checkbox__input" name="optionsRadios" value="11">
                                        <label for="rbtOpcion11" class="checkbox__label"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <textarea id="txtOtrosCancelado" class="form-control"></textarea>
                            </div>
                            <div class="block-center text-center">
                                <a id="btnEnviarCanceladoPedido" class="btn btn-action-hover btn-round">Enviar</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="popupPedidoAceptado" class="modal fade" data-backdrop="static" data-keyboard="false" style="z-index: 10000 !important; ">
    <div class="modal-dialog modal-alert ">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-12">
                        <a href="@Url.Action("MisPedidos", "ConsultoraOnline", new { area = "Mobile" })" class="close"><i class="icon-close-belcorp"></i></a>
                        <div class="alert-top-icon text-success">
                            <i class="icon-exclamation-circle"></i>
                            <h3 class="text-success" style="margin-top: 10px;">Has aceptado el pedido de @Model.Cliente</h3>
                        </div>
                    </div>
                </div>
                <div class="row text-left">
                    <div class="col-xs-12">
                        <div class="mb-10 text-center"><small>Si no tienes los productos en stock, no te olvides de agregarlos a tu pedido.</small></div>
                        @if (Model.DetallePedido.Any())
                        {
                            <div class="list-table-new fz-14">
                                <ul class="list-table-title upper">
                                    <li style="padding-bottom: 0;">Productos <span class="table-title-right">Cant</span></li>
                                </ul>
                                <ul class="list-table-body">
                                    @foreach (var item in Model.DetallePedido)
                                    {
                                        var textoTono = @item.Tono == "" ? "" : "Tono: " + item.Tono + "<br/>";

                                        <li>
                                            <div class="posr">
                                                <div class="table-width">
                                                    <div class="mb-10">
                                                        <strong class="upper">@item.Producto</strong>
                                                    </div>
                                                    @Html.Raw(textoTono)
                                                    @item.Marca <br />
                                                    <div class="upper">Total @ViewBag.Simbolo @item.PrecioTotal.ToString("N2")</div>
                                                </div>
                                                <span class="cantidad-numero"> @item.Cantidad </span>
                                            </div>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                        <div class="block-center text-center">
                            <a href="@Url.Action("MisPedidos", "ConsultoraOnline", new { area = "Mobile" })" class="btn btn-line-action btn-round btn-align">Regresar</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script type="text/javascript">

        var urlAceptarPedido = '@Url.Action("AceptarPedido", "ConsultoraOnline", new {area = "Mobile"})';
        var urlRechazarPedido = '@Url.Action("RechazarPedido", "ConsultoraOnline", new { area = "Mobile" })';
        var urlCancelarPedido = '@Url.Action("CancelarPedido", "ConsultoraOnline", new { area = "Mobile" })';
        var urlRefrescarCantidadPedidos = '@Url.Action("MisPedidos", "ConsultoraOnline", new { area = "Mobile" })';

        $(document).ready(function () {

            $("#btnAceptarPedido").click(function () {
                var params = {
                    id: $("#PedidoId").val()
                };

                ShowLoading();

                jQuery.ajax({
                    type: 'POST',
                    url: urlAceptarPedido,
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(params),
                    async: true,
                    success: function (data) {
                        if (checkTimeout(data)) {
                            CloseLoading();

                            if (data.success == true) {
                                $("#popupPedidoAceptado").modal("show");
                            } else {
                                messageInfo("Ocurrio un Error al momento de aceptar el Pedido");
                            }
                        }
                    },
                    error: function (data, error) {
                        if (checkTimeout(data)) {
                            CloseLoading();
                            messageInfo("Ocurrio un Error al momento de aceptar el Pedido");
                        }
                    }
                });
            });

            $("#btnRechazarPedido").click(function () {
                $("#popupRechazar").modal("show");
            });

            $("#btnEnviarRechazoPedido").click(function () {
                var opcion = $('input[type=radio]:checked').val();

                if (opcion == undefined) {
                    messageInfo("Seleccione una opcion para la Rechazar el Pedido");
                } else {
                    var parametros = {
                        SolicitudId: $("#PedidoId").val(),
                        NumIteracion: $("#NumIteracion").val(),
                        CodigoUbigeo: $("#CodigoUbigeo").val(),
                        Campania: $("#Campania").val(),
                        MarcaId: $("#MarcaID").val(),
                        OpcionRechazo: opcion,
                        RazonMotivoRechazo: $("#txtOtrosRechazo").val()
                    };

                    ShowLoading();

                    jQuery.ajax({
                        type: 'POST',
                        url: urlRechazarPedido,
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(parametros),
                        async: true,
                        success: function (data) {
                            if (checkTimeout(data)) {
                                CloseLoading();

                                if (data.success == true) {
                                    $("#popupRechazar").modal("hide");
                                    messageInfo(data.message, function () { UpdateCantidadPedidos(); });
                                } else {
                                    messageInfo("Ocurrio un Error al momento de rechazar el Pedido");
                                }
                            }
                        },
                        error: function (data, error) {
                            if (checkTimeout(data)) {
                                CloseLoading();
                                messageInfo("Ocurrio un Error al momento de rechazar el Pedido");
                            }
                        }
                    });
                }
            });

            $("#btnCancelarPedido").click(function () {
                $("#popupCancelar").modal("show");
            });

            $("#btnEnviarCanceladoPedido").click(function () {
                var opcion = $('input[type=radio]:checked').val();

                if (opcion == undefined) {
                    messageInfo("Seleccione una opcion para la Cancelar el Pedido");
                } else {
                    var parametros = {
                        SolicitudId: $("#PedidoId").val(),
                        OpcionCancelado: opcion,
                        RazonMotivoCancelado: $("#txtOtrosCancelado").val()
                    };

                    ShowLoading();

                    jQuery.ajax({
                        type: 'POST',
                        url: urlCancelarPedido,
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(parametros),
                        async: true,
                        success: function (data) {
                            if (checkTimeout(data)) {
                                CloseLoading();

                                if (data.success == true) {
                                    $("#popupCancelar").modal("hide");
                                    messageInfo(data.message, function () { UpdateCantidadPedidos(); });
                                } else {
                                    messageInfo("Ocurrio un error al momento de Cancelar la solicitud");
                                }
                            }
                        },
                        error: function (data, error) {
                            if (checkTimeout(data)) {
                                CloseLoading();
                                messageInfo("Ocurrio un error al momento de Cancelar la solicitud");
                            }
                        }
                    });
                }
            });
        });

        function UpdateCantidadPedidos() {
            window.location = urlRefrescarCantidadPedidos;
        }
    </script>
}